

# 7장. 서브쿼리

## 7-1. 서브쿼리가 일으키는 폐해

서브쿼리는 편리하지만, 잘못 쓰면 성능이 크게 떨어집니다.
특히 \*\*상관 서브쿼리(Correlated Subquery)\*\*는 외부 쿼리의 각 행마다 실행되므로 주의해야 합니다.

---

### 예제 1: 상관 서브쿼리 (비효율 가능성)

```sql
SELECT c.customer_id, c.name,
       (SELECT SUM(total_amount)
        FROM orders o
        WHERE o.customer_id = c.customer_id) AS sum_orders
FROM customers c;
-- 주석:
-- customers의 각 행마다 orders를 다시 조회 → 고객 수가 많을수록 반복 실행
```

---

### 예제 2: 조인으로 대체 (효율적)

```sql
SELECT c.customer_id, c.name, SUM(o.total_amount) AS sum_orders
FROM customers c
LEFT JOIN orders o ON o.customer_id = c.customer_id
GROUP BY c.customer_id, c.name;
-- 주석:
-- 한 번의 조인 + 그룹 집계로 동일한 결과
```

---

## 7-2. 서브쿼리 사용이 더 나은 경우

서브쿼리가 반드시 유리한 경우도 있습니다.

---

### 예제 3: IN 서브쿼리

```sql
SELECT *
FROM orders
WHERE customer_id IN (
  SELECT customer_id
  FROM customers
  WHERE tier = 'A'
);
-- 주석:
-- tier='A'인 고객의 주문만 가져오기
-- customers가 작은 테이블이면 간단하고 빠름
```

---

### 예제 4: NOT EXISTS

```sql
SELECT c.*
FROM customers c
WHERE NOT EXISTS (
  SELECT 1
  FROM orders o
  WHERE o.customer_id = c.customer_id
);
-- 주석:
-- 주문이 없는 고객 찾기
-- 옵티마이저가 효율적으로 처리 가능
```

---

### 예제 5: FROM 절의 서브쿼리 (인라인 뷰)

```sql
SELECT sub.customer_id, sub.total_sum
FROM (
  SELECT customer_id, SUM(total_amount) AS total_sum
  FROM orders
  GROUP BY customer_id
) sub
WHERE sub.total_sum >= 1000;
-- 주석:
-- 복잡한 집계를 먼저 구하고, 그 결과를 다시 필터링
```

---

## 7-3. 서브쿼리와 조인의 선택 기준

| 상황              | 서브쿼리 추천 | 조인 추천 |
| --------------- | ------- | ----- |
| 단순 조건 필터링       | ✔       |       |
| 집계 후 필터링        | ✔       |       |
| 대량 데이터, 상관 서브쿼리 |         | ✔     |
| 여러 컬럼 조합 결과 필요  |         | ✔     |

---

## 요약

* 상관 서브쿼리는 행마다 반복 실행 → 대량 데이터에서 느림
* 조인으로 대체 가능한 경우가 많음
* 하지만 집계 결과 재사용, 간단한 필터 조건에는 서브쿼리가 간결할 수 있음

