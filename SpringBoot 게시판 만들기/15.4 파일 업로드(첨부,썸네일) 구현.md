좋습니다. 이제 15-4 단계, **파일 업로드(첨부/썸네일)** 구현으로 넘어가겠습니다.
게시판 API에서 흔히 필요한 기능으로, 글 작성 시 이미지/파일을 업로드하고 서버에 저장한 뒤 URL을 반환하는 방식입니다.

---

# 1) 가장 일반적인 구현 전략

1. **파일 저장소 선택**

   * 개발/테스트 단계 → 로컬 디스크(`uploads/`)에 저장
   * 운영 단계 → AWS S3, NCP Object Storage, Google Cloud Storage 등
2. **DB에 저장하는 내용**

   * 실제 파일(binary) 자체는 저장하지 않고 **파일 경로/URL/원본파일명/크기**만 저장
   * 필요시 게시글 ID(`post_id`)와 연결

---

# 2) DB 테이블 추가

```sql
USE boarddb;

CREATE TABLE attachments (
  id          BIGINT PRIMARY KEY AUTO_INCREMENT,
  post_id     BIGINT NOT NULL,
  file_name   VARCHAR(255) NOT NULL,   -- 원본 파일명
  file_path   VARCHAR(500) NOT NULL,   -- 서버에 저장된 경로
  file_size   BIGINT NOT NULL,
  content_type VARCHAR(100),
  created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_attachments_post FOREIGN KEY (post_id) REFERENCES posts(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

# 3) 업로드 경로 설정

`src/main/resources/application.yml`

```yaml
file:
  upload-dir: uploads   # 기본 저장 폴더
```

스프링 부트 실행 시 `uploads/` 폴더가 자동 생성되도록 Bean 설정을 추가합니다.

---

# 4) 파일 저장 서비스

`src/main/java/com/example/boardapi/service/FileService.java`

```java
package com.example.boardapi.service;

import com.example.boardapi.domain.Attachment;
import com.example.boardapi.mapper.AttachmentMapper;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.UUID;

@Service
public class FileService {

    private final Path rootLocation;
    private final AttachmentMapper attachmentMapper;

    public FileService(@Value("${file.upload-dir}") String uploadDir,
                       AttachmentMapper attachmentMapper) throws IOException {
        this.rootLocation = Paths.get(uploadDir).toAbsolutePath().normalize();
        this.attachmentMapper = attachmentMapper;
        Files.createDirectories(this.rootLocation);
    }

    public Long saveFile(Long postId, MultipartFile file) throws IOException {
        String original = file.getOriginalFilename();
        String ext = (original != null && original.contains(".")) ?
                original.substring(original.lastIndexOf(".")) : "";
        String saved = UUID.randomUUID() + ext;

        Path target = this.rootLocation.resolve(saved);
        Files.copy(file.getInputStream(), target);

        Attachment att = new Attachment();
        att.setPostId(postId);
        att.setFileName(original);
        att.setFilePath(target.toString());
        att.setFileSize(file.getSize());
        att.setContentType(file.getContentType());

        attachmentMapper.insert(att);
        return att.getId();
    }
}
```

---

# 5) Attachment 엔티티/매퍼

`src/main/java/com/example/boardapi/domain/Attachment.java`

```java
package com.example.boardapi.domain;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class Attachment {
    private Long id;
    private Long postId;
    private String fileName;
    private String filePath;
    private Long fileSize;
    private String contentType;
    private LocalDateTime createdAt;
}
```

`src/main/java/com/example/boardapi/mapper/AttachmentMapper.java`

```java
package com.example.boardapi.mapper;

import com.example.boardapi.domain.Attachment;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface AttachmentMapper {
    int insert(Attachment att);
    List<Attachment> findByPost(@Param("postId") Long postId);
    Attachment findById(@Param("id") Long id);
}
```

`src/main/resources/mapper/AttachmentMapper.xml`

```xml
<mapper namespace="com.example.boardapi.mapper.AttachmentMapper">

  <insert id="insert" parameterType="com.example.boardapi.domain.Attachment" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO attachments (post_id, file_name, file_path, file_size, content_type)
    VALUES (#{postId}, #{fileName}, #{filePath}, #{fileSize}, #{contentType})
  </insert>

  <select id="findByPost" resultType="com.example.boardapi.domain.Attachment">
    SELECT id, post_id, file_name, file_path, file_size, content_type, created_at
    FROM attachments
    WHERE post_id = #{postId}
  </select>

  <select id="findById" resultType="com.example.boardapi.domain.Attachment">
    SELECT id, post_id, file_name, file_path, file_size, content_type, created_at
    FROM attachments
    WHERE id = #{id}
  </select>
</mapper>
```

---

# 6) 파일 업로드 API

`src/main/java/com/example/boardapi/controller/FileController.java`

```java
package com.example.boardapi.controller;

import com.example.boardapi.service.FileService;
import com.example.boardapi.util.ApiResponse;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/api/files")
public class FileController {

    private final FileService fileService;
    public FileController(FileService fileService){ this.fileService = fileService; }

    // 게시글 첨부파일 업로드
    @PostMapping("/upload/{postId}")
    public ApiResponse<Long> upload(@PathVariable Long postId,
                                    @RequestParam("file") MultipartFile file) throws Exception {
        Long fileId = fileService.saveFile(postId, file);
        return ApiResponse.ok(fileId);
    }
}
```

---

# 7) 빠른 점검 (curl)

```bash
# 첨부파일 업로드 (postId=1)
curl -X POST http://localhost:8080/api/files/upload/1 \
  -H "Authorization: Bearer <token>" \
  -F "file=@sample.png"
```

DB `attachments` 테이블에 기록이 생기고, `uploads/` 폴더에 실제 파일이 저장됩니다.

---

# 8) 확장 (썸네일 생성)

* 이미지 파일일 경우 업로드 시 썸네일을 생성
* 자바에서 `Thumbnailator` 라이브러리(가장 일반적) 사용

pom.xml:

```xml
<dependency>
  <groupId>net.coobird</groupId>
  <artifactId>thumbnailator</artifactId>
  <version>0.4.20</version>
</dependency>
```

FileService에 추가:

```java
if (file.getContentType() != null && file.getContentType().startsWith("image")) {
    Path thumb = this.rootLocation.resolve("thumb_" + saved);
    Thumbnails.of(target.toFile())
              .size(200, 200)
              .toFile(thumb.toFile());
}
```

---

# 9) 이해 포인트

* **파일은 로컬/클라우드에 저장, DB에는 메타데이터만 저장** → 가장 일반적 구조
* **UUID로 파일명 관리** → 중복 방지, 보안 강화
* **썸네일 별도 저장** → 프론트에서 목록 로딩 시 속도 향상
* **MultipartFile 처리**는 스프링이 기본 제공하는 기능

---

여기까지가 **파일 업로드(첨부/썸네일)** 구현의 기본 과정입니다.
다음 단계는 15-5, \*\*조회수 중복 방지(세션/토큰/레디스 활용)\*\*인데 바로 이어서 설명드릴까요?
