좋습니다. 이제 15-3 단계, \*\*JWT 로그인(회원가입/로그인/권한)\*\*으로 진행하겠습니다.
이 부분은 API 서버에서 **사용자 인증·인가**를 구현하는 가장 일반적인 방법입니다.

---

# 1) JWT 인증 개요

* **JWT (JSON Web Token)**: 로그인 성공 시 서버가 토큰 발급 → 클라이언트는 이후 요청 시 `Authorization: Bearer <token>` 헤더에 포함
* 서버는 토큰을 검증해 사용자 정보 확인 → 권한(Role)에 따라 접근 제어
* **장점**: 무상태(stateless)라서 서버 세션을 따로 관리할 필요 없음.
* **흐름**:

  1. 회원가입 → DB에 유저 저장
  2. 로그인 → 비밀번호 검증 후 JWT 발급
  3. 요청 시 JWT 전달 → 서버에서 유효성 검증 후 접근 허용

---

# 2) 의존성 추가 (pom.xml)

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-api</artifactId>
  <version>0.11.5</version>
</dependency>
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-impl</artifactId>
  <version>0.11.5</version>
  <scope>runtime</scope>
</dependency>
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-jackson</artifactId>
  <version>0.11.5</version>
  <scope>runtime</scope>
</dependency>
```

---

# 3) DB 수정 (비밀번호/권한 컬럼 추가)

```sql
ALTER TABLE users
  ADD COLUMN password VARCHAR(255) NOT NULL AFTER display_name,
  ADD COLUMN role     VARCHAR(20)  NOT NULL DEFAULT 'USER' AFTER password;

-- 샘플 유저 (비밀번호는 추후 BCrypt로 암호화)
INSERT INTO users(username, display_name, password, role)
VALUES ('admin','관리자','$2a$10$7NwvX9gMzN/4D7...암호화값','ADMIN');
```

---

# 4) User 엔티티 수정

`src/main/java/com/example/boardapi/domain/User.java`

```java
@Data
public class User {
    private Long id;
    private String username;
    private String displayName;
    private String password;   // 암호화된 값
    private String role;       // USER / ADMIN
    private LocalDateTime createdAt;
}
```

---

# 5) DTO 추가

`src/main/java/com/example/boardapi/dto/AuthRequest.java`

```java
package com.example.boardapi.dto;

import jakarta.validation.constraints.NotBlank;

public record AuthRequest(
        @NotBlank String username,
        @NotBlank String password
) {}
```

`src/main/java/com/example/boardapi/dto/AuthResponse.java`

```java
package com.example.boardapi.dto;

public record AuthResponse(
        String accessToken,
        String tokenType
) {
    public static AuthResponse of(String token) {
        return new AuthResponse(token, "Bearer");
    }
}
```

---

# 6) JWT 유틸리티

`src/main/java/com/example/boardapi/util/JwtUtil.java`

```java
package com.example.boardapi.util;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;

@Component
public class JwtUtil {

    private final Key key = Keys.hmacShaKeyFor("MySuperSecretKeyForJwtAuth1234567890".getBytes());
    private final long expirationMs = 1000 * 60 * 60; // 1시간

    public String generateToken(String username, String role) {
        return Jwts.builder()
                .setSubject(username)
                .claim("role", role)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + expirationMs))
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    public Jws<Claims> validateToken(String token) {
        return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
    }

    public String getUsername(String token) {
        return validateToken(token).getBody().getSubject();
    }

    public String getRole(String token) {
        return (String) validateToken(token).getBody().get("role");
    }
}
```

---

# 7) Spring Security 설정

`src/main/java/com/example/boardapi/config/SecurityConfig.java`

```java
package com.example.boardapi.config;

import com.example.boardapi.filter.JwtAuthenticationFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtFilter;

    public SecurityConfig(JwtAuthenticationFilter jwtFilter) {
        this.jwtFilter = jwtFilter;
    }

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll() // 로그인/회원가입은 허용
                .requestMatchers("/swagger-ui/**","/v3/api-docs/**").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

---

# 8) JWT 필터

`src/main/java/com/example/boardapi/filter/JwtAuthenticationFilter.java`

```java
package com.example.boardapi.filter;

import com.example.boardapi.util.JwtUtil;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jws;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtUtil jwtUtil;
    public JwtAuthenticationFilter(JwtUtil jwtUtil){ this.jwtUtil = jwtUtil; }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain)
            throws ServletException, IOException {

        String header = request.getHeader("Authorization");
        if (header != null && header.startsWith("Bearer ")) {
            String token = header.substring(7);

            try {
                Jws<Claims> claims = jwtUtil.validateToken(token);
                String username = claims.getBody().getSubject();
                String role = (String) claims.getBody().get("role");

                UsernamePasswordAuthenticationToken auth =
                        new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());
                auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                SecurityContextHolder.getContext().setAuthentication(auth);
            } catch (Exception e) {
                // 토큰 무효 → 무시
            }
        }

        chain.doFilter(request, response);
    }
}
```

---

# 9) 인증 서비스 & 컨트롤러

`src/main/java/com/example/boardapi/service/AuthService.java`

```java
package com.example.boardapi.service;

import com.example.boardapi.domain.User;
import com.example.boardapi.dto.AuthRequest;
import com.example.boardapi.dto.AuthResponse;
import com.example.boardapi.exception.ApiException;
import com.example.boardapi.exception.ErrorCode;
import com.example.boardapi.mapper.UserMapper;
import com.example.boardapi.util.JwtUtil;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class AuthService {

    private final UserMapper userMapper;
    private final JwtUtil jwtUtil;
    private final BCryptPasswordEncoder encoder;

    public AuthService(UserMapper userMapper, JwtUtil jwtUtil, BCryptPasswordEncoder encoder) {
        this.userMapper = userMapper;
        this.jwtUtil = jwtUtil;
        this.encoder = encoder;
    }

    public void signup(User user) {
        user.setPassword(encoder.encode(user.getPassword()));
        user.setRole("USER");
        userMapper.insert(user);
    }

    public AuthResponse login(AuthRequest req) {
        User found = userMapper.findByUsername(req.username());
        if (found == null || !encoder.matches(req.password(), found.getPassword())) {
            throw new ApiException(ErrorCode.BAD_REQUEST);
        }
        String token = jwtUtil.generateToken(found.getUsername(), found.getRole());
        return AuthResponse.of(token);
    }
}
```

`src/main/java/com/example/boardapi/controller/AuthController.java`

```java
package com.example.boardapi.controller;

import com.example.boardapi.domain.User;
import com.example.boardapi.dto.AuthRequest;
import com.example.boardapi.dto.AuthResponse;
import com.example.boardapi.service.AuthService;
import com.example.boardapi.util.ApiResponse;
import jakarta.validation.Valid;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    private final AuthService authService;
    public AuthController(AuthService authService){ this.authService = authService; }

    @PostMapping("/signup")
    public ApiResponse<Void> signup(@RequestBody @Valid User user) {
        authService.signup(user);
        return ApiResponse.ok(null, "회원가입 성공");
    }

    @PostMapping("/login")
    public ApiResponse<AuthResponse> login(@RequestBody @Valid AuthRequest req) {
        return ApiResponse.ok(authService.login(req));
    }
}
```

---

# 10) Mapper 추가

`src/main/java/com/example/boardapi/mapper/UserMapper.java`

```java
package com.example.boardapi.mapper;

import com.example.boardapi.domain.User;
import org.apache.ibatis.annotations.Param;

public interface UserMapper {
    int insert(User user);
    User findByUsername(@Param("username") String username);
}
```

`src/main/resources/mapper/UserMapper.xml`

```xml
<mapper namespace="com.example.boardapi.mapper.UserMapper">

  <insert id="insert" parameterType="com.example.boardapi.domain.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO users (username, display_name, password, role)
    VALUES (#{username}, #{displayName}, #{password}, #{role})
  </insert>

  <select id="findByUsername" resultType="com.example.boardapi.domain.User">
    SELECT id, username, display_name, password, role, created_at
    FROM users
    WHERE username = #{username}
  </select>

</mapper>
```

---

# 11) 빠른 점검 (curl)

```bash
# 1) 회원가입
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"username":"test","displayName":"테스트","password":"1234"}'

# 2) 로그인
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"1234"}'

# → {"success":true,"data":{"accessToken":"...","tokenType":"Bearer"}}

# 3) 토큰으로 게시글 요청
curl http://localhost:8080/api/posts \
  -H "Authorization: Bearer <accessToken>"
```

---

# 12) 이해 포인트

* **회원가입 시 비밀번호 암호화**: 반드시 BCrypt 같은 단방향 해시 사용
* **JWT 토큰**: 발급 시 username + role 포함, 검증 시 무결성 확인
* **Spring Security 필터 체인**: `/api/auth/**`는 허용, 나머지는 토큰 필요
* **권한 제어**: 필요 시 `@PreAuthorize("hasRole('ADMIN')")` 같은 어노테이션으로 세밀하게 제어 가능

---

여기까지가 **JWT 로그인/회원가입/권한 기반 인증** 구현입니다.
다음 단계는 15-4, \*\*파일 업로드(첨부/썸네일)\*\*인데, 바로 이어서 진행해드릴까요?
