좋습니다. 이번에는 **68번 – useUpload 파일 업로드 상태 관리** 예제를 보겠습니다.

---

## 68. useUpload 파일 업로드 상태 관리

### 목표

* 여러 개의 파일 업로드 진행 상황을 관리
* 진행률(%) 추적, 성공/실패 상태 관리
* 업로드 취소 기능까지 지원

---

### 파일 경로 / 파일명

```
src/hooks/useUpload.js
src/App.js
```

---

### 1) 커스텀 훅 – `useUpload.js`

```javascript
import { useState, useCallback } from "react";

/**
 * useUpload(uploadFn)
 * - uploadFn(file, onProgress) => Promise<any>
 * - 반환:
 *   { uploads, uploadFiles, cancelUpload, reset }
 */
export default function useUpload(uploadFn) {
  const [uploads, setUploads] = useState([]); 
  // [{ id, file, progress, status: 'pending'|'uploading'|'success'|'error'|'canceled', error }]

  const uploadFiles = useCallback((files) => {
    const newUploads = files.map((file) => ({
      id: Math.random().toString(36).slice(2),
      file,
      progress: 0,
      status: "pending",
      error: null,
    }));

    setUploads((prev) => [...prev, ...newUploads]);

    newUploads.forEach((item) => {
      setUploads((prev) =>
        prev.map((u) => (u.id === item.id ? { ...u, status: "uploading" } : u))
      );

      uploadFn(item.file, (p) => {
        setUploads((prev) =>
          prev.map((u) =>
            u.id === item.id ? { ...u, progress: p } : u
          )
        );
      })
        .then(() => {
          setUploads((prev) =>
            prev.map((u) =>
              u.id === item.id ? { ...u, status: "success", progress: 100 } : u
            )
          );
        })
        .catch((err) => {
          setUploads((prev) =>
            prev.map((u) =>
              u.id === item.id ? { ...u, status: "error", error: err } : u
            )
          );
        });
    });
  }, [uploadFn]);

  const cancelUpload = useCallback((id) => {
    setUploads((prev) =>
      prev.map((u) => (u.id === id ? { ...u, status: "canceled" } : u))
    );
    // 실제 네트워크 취소는 uploadFn에서 AbortController 지원 필요
  }, []);

  const reset = useCallback(() => setUploads([]), []);

  return { uploads, uploadFiles, cancelUpload, reset };
}
```

---

### 2) 사용 예제 – `App.js`

```javascript
import React, { useRef } from "react";
import useUpload from "./hooks/useUpload";

// 가짜 업로드 함수 (fetch + progress 시뮬레이션)
async function fakeUpload(file, onProgress) {
  return new Promise((resolve, reject) => {
    let uploaded = 0;
    const total = file.size || 1000000; // 기본 크기 1MB 가정

    const timer = setInterval(() => {
      uploaded += total / 20; // 5%씩 업로드
      const progress = Math.min(100, Math.round((uploaded / total) * 100));
      onProgress(progress);
      if (progress >= 100) {
        clearInterval(timer);
        // 20% 확률로 실패 시뮬레이션
        if (Math.random() < 0.2) reject(new Error("업로드 실패"));
        else resolve({ ok: true });
      }
    }, 200);
  });
}

export default function App() {
  const { uploads, uploadFiles, cancelUpload, reset } = useUpload(fakeUpload);
  const fileInput = useRef(null);

  const handleSelect = () => {
    const files = Array.from(fileInput.current.files);
    if (files.length) {
      uploadFiles(files);
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <h1>useUpload 파일 업로드 상태 관리</h1>

      <input type="file" multiple ref={fileInput} />
      <button onClick={handleSelect}>업로드 시작</button>
      <button onClick={reset}>초기화</button>

      <ul style={{ marginTop: 20 }}>
        {uploads.map((u) => (
          <li key={u.id} style={{ marginBottom: 10 }}>
            <strong>{u.file.name}</strong> - {u.status}
            <div
              style={{
                width: 300,
                height: 8,
                background: "#e5e7eb",
                borderRadius: 4,
                overflow: "hidden",
                marginTop: 4,
              }}
            >
              <div
                style={{
                  width: `${u.progress}%`,
                  height: "100%",
                  background:
                    u.status === "error" ? "crimson" :
                    u.status === "success" ? "green" : "#2563eb",
                  transition: "width 0.2s",
                }}
              />
            </div>
            {u.status === "uploading" && (
              <button onClick={() => cancelUpload(u.id)} style={{ marginLeft: 10 }}>
                취소
              </button>
            )}
            {u.error && <p style={{ color: "red" }}>에러: {u.error.message}</p>}
          </li>
        ))}
      </ul>
    </div>
  );
}
```

---

### 동작 방식

1. `uploadFiles(files)` 호출 시 파일마다 업로드 상태 추가
2. `uploadFn(file, onProgress)` 실행 → 진행률 업데이트
3. 성공 시 `status = success`, 실패 시 `status = error`
4. `cancelUpload(id)` → 상태만 `canceled` 표시 (실제 취소는 `uploadFn`에서 AbortController 지원 필요)

---

### 활용 아이디어

* **대용량 파일 업로드** (동영상, 이미지)
* **여러 파일 동시 업로드**
* **업로드 대기열/취소 기능**
* 백엔드에서 presigned URL(S3 등)과 함께 사용

---

다음은 **69번 – useDownload 파일 다운로드 상태 관리** 예제로 넘어가시겠습니까?
