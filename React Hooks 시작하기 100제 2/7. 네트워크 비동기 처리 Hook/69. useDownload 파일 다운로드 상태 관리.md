좋습니다. 이번에는 **69번 – useDownload 파일 다운로드 상태 관리** 예제를 보겠습니다.

---

## 69. useDownload 파일 다운로드 상태 관리

### 목표

* 파일 다운로드 진행률을 추적 (`progress %`)
* 다운로드 완료/실패 상태 관리
* 취소 기능 (`AbortController`) 지원

---

### 파일 경로 / 파일명

```
src/hooks/useDownload.js
src/App.js
```

---

### 1) 커스텀 훅 – `useDownload.js`

```javascript
import { useState, useCallback } from "react";

/**
 * useDownload()
 * 반환:
 * { downloading, progress, error, download, cancel }
 */
export default function useDownload() {
  const [downloading, setDownloading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [error, setError] = useState(null);
  const controllerRef = new AbortController();

  const cancel = useCallback(() => {
    controllerRef.abort();
    setDownloading(false);
  }, []);

  const download = useCallback(async (url, filename = "downloaded.file") => {
    setDownloading(true);
    setProgress(0);
    setError(null);

    const controller = new AbortController();
    controllerRef.signal = controller.signal;

    try {
      const res = await fetch(url, { signal: controller.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const contentLength = res.headers.get("content-length");
      const total = contentLength ? parseInt(contentLength, 10) : 0;

      const reader = res.body.getReader();
      let received = 0;
      const chunks = [];

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (total) {
          setProgress(Math.round((received / total) * 100));
        }
      }

      // Blob 생성 후 다운로드
      const blob = new Blob(chunks);
      const urlObject = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = urlObject;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(urlObject);

      setProgress(100);
      setDownloading(false);
    } catch (err) {
      if (err.name !== "AbortError") {
        setError(err);
      }
      setDownloading(false);
    }
  }, []);

  return { downloading, progress, error, download, cancel };
}
```

---

### 2) 사용 예제 – `App.js`

```javascript
import React from "react";
import useDownload from "./hooks/useDownload";

export default function App() {
  const { downloading, progress, error, download, cancel } = useDownload();

  const handleDownload = () => {
    download(
      "https://file-examples.com/storage/fe7b4b0d2e4c7b8c76d4b8f/2017/10/file-sample_150kB.pdf",
      "샘플.pdf"
    );
  };

  return (
    <div style={{ padding: 20 }}>
      <h1>useDownload 파일 다운로드 상태 관리</h1>
      <button onClick={handleDownload} disabled={downloading}>
        {downloading ? "다운로드 중..." : "파일 다운로드"}
      </button>
      {downloading && (
        <button onClick={cancel} style={{ marginLeft: 10 }}>
          취소
        </button>
      )}

      {downloading && <p>진행률: {progress}%</p>}
      {error && <p style={{ color: "red" }}>에러: {error.message}</p>}
    </div>
  );
}
```

---

### 동작 방식

1. `download(url, filename)` 호출 → fetch + `ReadableStream` 으로 청크 읽기
2. `content-length` 헤더 기준으로 진행률 계산
3. Blob을 만들어 `<a download>` 트릭으로 저장
4. `cancel()` 호출 시 `AbortController`로 즉시 중단

---

### 활용 아이디어

* 대용량 PDF/엑셀 다운로드 진행률 표시
* 사용자에게 다운로드 취소 옵션 제공
* 다운로드가 끝난 후 자동 미리보기 열기

---

다음은 **70번 – useProgress 진행률 표시** 예제로 넘어가시겠습니까?
