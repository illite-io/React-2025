### 59. 회원 로그인 (세션 기반)

---

#### 1) **목표**

* 이메일과 비밀번호로 로그인 처리
* 로그인 성공 시 **세션(Session)에 사용자 정보 저장**

---

#### 2) **테이블 변경 (비밀번호 컬럼 추가)**

**SQL**

```sql
ALTER TABLE user ADD COLUMN password VARCHAR(255) NOT NULL AFTER email;
```

---

#### 3) **DTO 수정**

**경로**: `src/main/java/com/example/springbootstart/dto/UserDto.java`

```java
@Getter
@Setter
@ToString
public class UserDto {
    private Long id;
    private String name;
    private int age;
    private String email;
    private String password;   // 비밀번호
    private String createdAt;
    private String updatedAt;
}
```

---

#### 4) **Mapper 인터페이스**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
@Mapper
public interface UserMapper {
    UserDto findByEmail(@Param("email") String email);
}
```

---

#### 5) **Mapper XML**

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<select id="findByEmail" parameterType="string" resultType="com.example.springbootstart.dto.UserDto">
    SELECT id, name, age, email, password, created_at AS createdAt, updated_at AS updatedAt
    FROM user
    WHERE email = #{email}
</select>
```

---

#### 6) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
import javax.servlet.http.HttpSession;

public UserDto login(String email, String password, HttpSession session) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("존재하지 않는 이메일입니다.");
    if (!user.getPassword().equals(password)) throw new RuntimeException("비밀번호가 일치하지 않습니다.");

    // 세션에 사용자 정보 저장
    session.setAttribute("loginUser", user);
    return user;
}
```

---

#### 7) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
import javax.servlet.http.HttpSession;

@PostMapping("/login")
public ResponseEntity<?> login(@RequestParam String email,
                               @RequestParam String password,
                               HttpSession session) {
    try {
        UserDto user = userService.login(email, password, session);
        return ResponseEntity.ok(Map.of("message", "로그인 성공", "user", user));
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(Map.of("message", e.getMessage()));
    }
}

@GetMapping("/logout")
public ResponseEntity<?> logout(HttpSession session) {
    session.invalidate();
    return ResponseEntity.ok(Map.of("message", "로그아웃 성공"));
}
```

---

#### 8) **테스트 요청**

**POST 요청**

```
http://localhost:8080/users/login
```

**Body (x-www-form-urlencoded)**

```
email=hong@test.com
password=1234
```

**응답(JSON)**

```json
{
  "message": "로그인 성공",
  "user": {
    "id": 1,
    "name": "홍길동",
    "age": 30,
    "email": "hong@test.com",
    "password": "1234"
  }
}
```

**로그아웃 요청**

```
GET http://localhost:8080/users/logout
```

**응답**

```json
{
  "message": "로그아웃 성공"
}
```

---

#### 9) **결과**

* 로그인 성공 시 세션에 사용자 정보 저장
* 로그아웃 시 세션 삭제

---

**다음 단계는 `60. 로그인 사용자만 글 작성 가능 (세션 검사)` 입니다. 진행할까요?**
