### 81. 사용자 프로필 썸네일 별도 관리

---

#### 1) **목표**

* 사용자 프로필 이미지 업로드 시 자동으로 **썸네일** 생성
* 기존 프로필 이미지는 원본 유지, 썸네일은 별도 경로(`uploads/profile/thumbs/`)에 저장
* 프로필 목록(예: 관리자 화면)에서 썸네일 사용 → 빠른 로딩

---

#### 2) **DB 변경**

**SQL**

```sql
ALTER TABLE user ADD COLUMN profile_thumb VARCHAR(255) AFTER profile_image;
```

---

#### 3) **ImageUtil 재사용**

이전 단계(80)에서 작성한 `ImageUtil.createThumbnail()` 활용

---

#### 4) **Service 수정**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
@Transactional
public void updateProfileImageWithThumbnail(Long userId, MultipartFile file) throws Exception {
    if (file.isEmpty()) return;

    // 원본 경로
    String folder = "uploads/profile/";
    String filename = userId + "_" + file.getOriginalFilename();
    Path path = Paths.get(folder + filename);
    Files.createDirectories(path.getParent());
    file.transferTo(path.toFile());

    String imagePath = "profile/" + filename;
    String thumbPath = null;

    // 썸네일 생성
    if (file.getContentType() != null && file.getContentType().startsWith("image")) {
        String thumbFolder = "uploads/profile/thumbs/";
        Files.createDirectories(Paths.get(thumbFolder));
        String thumbName = "thumb_" + filename;
        String fullThumbPath = thumbFolder + thumbName;
        ImageUtil.createThumbnail(path.toString(), fullThumbPath, 100, 100); // 썸네일 100x100
        thumbPath = "profile/thumbs/" + thumbName;
    }

    userMapper.updateProfileImageWithThumb(userId, imagePath, thumbPath);
}
```

---

#### 5) **Mapper**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
int updateProfileImageWithThumb(@Param("id") Long id,
                                @Param("profileImage") String profileImage,
                                @Param("profileThumb") String profileThumb);
```

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<update id="updateProfileImageWithThumb">
    UPDATE user 
    SET profile_image = #{profileImage}, profile_thumb = #{profileThumb} 
    WHERE id = #{id}
</update>
```

---

#### 6) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/profile-image-with-thumb")
public ResponseEntity<?> uploadProfileImageWithThumb(@RequestParam("file") MultipartFile file,
                                                     @RequestParam("userId") Long userId) {
    try {
        userService.updateProfileImageWithThumbnail(userId, file);
        return ResponseEntity.ok(Map.of("message", "프로필 이미지 및 썸네일 업로드 성공"));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}
```

---

#### 7) **정적 리소스 경로**

**WebConfig.java**

```java
registry.addResourceHandler("/profile/thumbs/**")
        .addResourceLocations("file:uploads/profile/thumbs/");
```

---

#### 8) **테스트**

1. **POST 요청**

```
POST /users/profile-image-with-thumb
Form-data:
- userId: 1
- file: (이미지)
```

2. **DB 확인**

```
SELECT profile_image, profile_thumb FROM user WHERE id=1;
```

→ 예: `profile/1_avatar.jpg`, `profile/thumbs/thumb_1_avatar.jpg`

3. **브라우저 접근**

```
http://localhost:8080/profile/thumbs/thumb_1_avatar.jpg
```

→ 썸네일 표시

---

### 결과

* 프로필 이미지 업로드 시 썸네일 자동 생성
* 목록이나 작은 UI에서 빠른 이미지 로딩 가능

---

**다음 단계는 `82. 첨부파일 메타데이터(크기, 타입) 저장` 입니다. 진행할까요?**
