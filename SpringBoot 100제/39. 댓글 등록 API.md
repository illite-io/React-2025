### 39. Service 계층 트랜잭션 적용

---

#### 1) **목표**

* 회원 정보 수정/삭제 등 **DB 변경 작업** 시 오류 발생 시 롤백 처리
* 데이터 정합성 유지

---

#### 2) **Spring Transaction 지원**

* Spring Boot는 `@Transactional` 어노테이션으로 트랜잭션 관리 제공
* 기본 DB 접근(MyBatis 포함)에서도 동작

---

#### 3) **Service 클래스 수정**

**파일 경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
package com.example.springbootstart.service;

import com.example.springbootstart.dto.UserDto;
import com.example.springbootstart.mapper.UserMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class UserService {
    private final UserMapper userMapper;

    public UserService(UserMapper userMapper) {
        this.userMapper = userMapper;
    }

    @Transactional
    public int createUser(UserDto userDto) {
        return userMapper.insertUser(userDto);
    }

    public UserDto getUser(Long id) {
        return userMapper.findById(id);
    }

    public List<UserDto> getAllUsers() {
        return userMapper.findAll();
    }

    @Transactional
    public int updateUser(UserDto userDto) {
        return userMapper.updateUser(userDto);
    }

    @Transactional
    public int deleteUser(Long id) {
        return userMapper.deleteUser(id);
    }
}
```

* `@Transactional` 적용 시 해당 메서드 실행 중 오류 발생 → 자동 롤백

---

#### 4) **트랜잭션 테스트 (강제 오류 발생)**

**Controller에 테스트 추가**

```java
@PostMapping("/transaction-test")
public ResponseEntity<?> transactionTest() {
    UserDto user = new UserDto();
    user.setName("트랜잭션 테스트");
    user.setAge(20);
    user.setEmail("test@test.com");

    userService.createUser(user);
    // 강제 오류 발생 → 트랜잭션 롤백
    if (true) throw new RuntimeException("강제 오류");
    
    return ResponseEntity.ok(Map.of("message", "정상 처리됨"));
}
```

**결과**

* 요청 후 DB에 데이터 추가 안됨 → 트랜잭션 롤백 정상 동작

---

#### 5) **주의점**

* `@Transactional`은 **Service 계층**에 적용하는 것이 일반적 (Controller보단 비즈니스 로직에 집중)
* `RuntimeException` 또는 `Error` 발생 시 기본 롤백
* 체크 예외 처리 시 `rollbackFor` 속성 추가 필요:

```java
@Transactional(rollbackFor = Exception.class)
```

---

**다음 단계는 `40. JUnit으로 단위 테스트 작성` 입니다. 진행할까요?**
