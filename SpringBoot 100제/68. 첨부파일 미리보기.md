### 68. 프로필 이미지 업로드 (Multipart)

---

#### 1) **목표**

* 사용자가 프로필 이미지를 업로드할 수 있도록 API 구현
* 업로드한 이미지 파일은 서버의 `uploads/profile` 폴더에 저장
* DB에 파일 경로를 저장

---

#### 2) **DB 컬럼 추가**

**SQL**

```sql
ALTER TABLE user ADD COLUMN profile_image VARCHAR(255) AFTER reset_token;
```

---

#### 3) **경로 준비**

* 프로젝트 루트에 `uploads/profile` 폴더 생성
* `.gitignore`에 추가(개인 이미지 저장소 관리 제외)

---

#### 4) **의존성 확인**

`spring-boot-starter-web` 이미 포함 시 Multipart 지원됨

**application.yml**

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 5MB
      max-request-size: 5MB
```

---

#### 5) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
import org.springframework.web.multipart.MultipartFile;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

@PostMapping("/profile-image")
public ResponseEntity<?> uploadProfileImage(@RequestParam("file") MultipartFile file,
                                            @RequestParam("userId") Long userId) {
    try {
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body("파일이 없습니다.");
        }

        // 저장 경로 설정
        String folder = "uploads/profile/";
        String filename = userId + "_" + file.getOriginalFilename();
        Path path = Paths.get(folder + filename);

        // 폴더 없으면 생성
        Files.createDirectories(path.getParent());
        file.transferTo(path.toFile());

        // DB에 이미지 경로 저장
        String dbPath = folder + filename;
        userService.updateProfileImage(userId, dbPath);

        return ResponseEntity.ok(Map.of("message", "프로필 이미지 업로드 성공", "path", dbPath));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("message", e.getMessage()));
    }
}
```

---

#### 6) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
@Transactional
public void updateProfileImage(Long userId, String imagePath) {
    userMapper.updateProfileImage(userId, imagePath);
}
```

---

#### 7) **Mapper**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
int updateProfileImage(@Param("id") Long id, @Param("profileImage") String profileImage);
```

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<update id="updateProfileImage">
    UPDATE user SET profile_image = #{profileImage} WHERE id = #{id}
</update>
```

---

#### 8) **테스트**

**POST 요청**

```
http://localhost:8080/users/profile-image
Form-Data:
file: (이미지 선택)
userId: 1
```

**응답**

```json
{
  "message": "프로필 이미지 업로드 성공",
  "path": "uploads/profile/1_profile.jpg"
}
```

---

#### 9) **결과**

* 사용자가 프로필 이미지를 업로드 가능
* DB에 경로 저장, 파일은 로컬 디스크에 보관

---

**다음 단계는 `69. 업로드한 프로필 이미지 제공 (URL로 접근)` 입니다. 진행할까요?**
