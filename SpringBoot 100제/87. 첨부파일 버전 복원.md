### 87. 첨부파일 히스토리 특정 버전 복원

---

#### 1) **목표**

* 저장된 파일 히스토리 중 특정 버전을 현재 파일로 복원
* 기존 현재 파일은 히스토리로 이동 (버전 증가)

---

#### 2) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
@Transactional
public void restoreFileVersion(Long fileId, int version) throws Exception {
    // 1) 복원할 히스토리 버전 찾기
    BoardFileHistoryDto historyVersion = boardFileMapper.findHistoryVersion(fileId, version);
    if (historyVersion == null) {
        throw new RuntimeException("해당 버전을 찾을 수 없습니다.");
    }

    // 2) 현재 파일 조회
    BoardFileDto currentFile = boardFileMapper.findFileById(fileId);
    if (currentFile == null) {
        throw new RuntimeException("현재 파일 정보를 찾을 수 없습니다.");
    }

    // 3) 현재 파일을 히스토리에 추가
    int maxVersion = boardFileMapper.findMaxVersion(fileId);
    BoardFileHistoryDto currentHistory = new BoardFileHistoryDto();
    currentHistory.setBoardFileId(fileId);
    currentHistory.setVersion(maxVersion + 1);
    currentHistory.setFileName(currentFile.getFileName());
    currentHistory.setFilePath(currentFile.getFilePath());
    currentHistory.setThumbnailPath(currentFile.getThumbnailPath());
    currentHistory.setFileSize(currentFile.getFileSize());
    currentHistory.setContentType(currentFile.getContentType());
    boardFileMapper.insertFileHistory(currentHistory);

    // 4) 현재 파일을 복원 파일로 교체
    currentFile.setFileName(historyVersion.getFileName());
    currentFile.setFilePath(historyVersion.getFilePath());
    currentFile.setThumbnailPath(historyVersion.getThumbnailPath());
    currentFile.setFileSize(historyVersion.getFileSize());
    currentFile.setContentType(historyVersion.getContentType());

    // DB 업데이트
    boardFileMapper.updateFileMeta(currentFile);
}
```

---

#### 3) **Mapper**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardFileMapper.java`

```java
BoardFileHistoryDto findHistoryVersion(@Param("fileId") Long fileId, @Param("version") int version);
int updateFileMeta(BoardFileDto fileDto);
```

**경로**: `src/main/resources/mapper/BoardFileMapper.xml`

```xml
<select id="findHistoryVersion" resultType="com.example.springbootstart.dto.BoardFileHistoryDto">
    SELECT * FROM board_file_history 
    WHERE board_file_id = #{fileId} AND version = #{version}
</select>

<update id="updateFileMeta" parameterType="com.example.springbootstart.dto.BoardFileDto">
    UPDATE board_file
    SET file_name = #{fileName},
        file_path = #{filePath},
        thumbnail_path = #{thumbnailPath},
        file_size = #{fileSize},
        content_type = #{contentType}
    WHERE id = #{id}
</update>
```

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardFileController.java`

```java
@PostMapping("/restore/{fileId}/{version}")
public ResponseEntity<?> restoreFileVersion(@PathVariable Long fileId,
                                            @PathVariable int version) {
    try {
        boardFileService.restoreFileVersion(fileId, version);
        return ResponseEntity.ok(Map.of("message", "파일 버전 복원 완료"));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}
```

---

#### 5) **테스트**

**POST 요청**

```
POST /board-files/restore/10/1
```

**결과**

* 현재 파일이 버전 1의 파일로 교체
* 기존 현재 파일은 새로운 버전 번호로 히스토리에 추가됨

**DB 확인**

```sql
SELECT * FROM board_file WHERE id=10; 
-- 버전 1 파일 내용으로 교체됨

SELECT * FROM board_file_history WHERE board_file_id=10 ORDER BY version DESC;
-- 최신 버전 기록이 추가됨
```

---

### 결과

* 과거 파일 버전 복원 가능
* 파일 이력 관리가 완전한 형태로 동작

---

**다음 단계는 `88. 게시글 + 첨부파일 전체 내보내기(Zip)` 입니다. 진행할까요?**
