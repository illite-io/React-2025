### 100. 전체 파일 접근 분석 리포트 자동 생성 (PDF)

---

#### 1) **목표**

* 전체 파일 접근 데이터를 요약하여 **PDF 리포트**로 자동 생성
* 주요 데이터:

  * 최근 30일 총 접근 수
  * Top 5 사용자
  * Top 5 파일
  * 최근 7일 일별 접근량 그래프

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>com.itextpdf</groupId>
    <artifactId>itext7-core</artifactId>
    <version>7.2.5</version>
</dependency>
```

> **iText7**: PDF 문서 생성 라이브러리
### 100. 전체 파일 접근 분석 리포트 자동 생성 (PDF)

---

#### 1) **목표**

* 전체 파일 접근 데이터를 요약하여 **PDF 리포트**로 자동 생성
* 주요 데이터:

  * 최근 30일 총 접근 수
  * Top 5 사용자
  * Top 5 파일
  * 최근 7일 일별 접근량 그래프

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>com.itextpdf</groupId>
    <artifactId>itext7-core</artifactId>
    <version>7.2.5</version>
</dependency>
```

> **iText7**: PDF 문서 생성 라이브러리

---

#### 3) **Service (리포트 생성)**

**경로**: `src/main/java/com/example/springbootstart/service/FileAccessLogService.java`

```java
import com.itextpdf.kernel.pdf.*;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.*;
import com.itextpdf.layout.property.UnitValue;
import org.springframework.core.io.ByteArrayResource;

public ResponseEntity<ByteArrayResource> generatePdfReport() throws IOException {
    // 데이터 수집
    int totalAccess = logMapper.countAccessLogs(null, null, null, null, null); // 전체 로그 수
    List<Map<String, Object>> topUsers = logMapper.findTop10Users().subList(0, Math.min(5, logMapper.findTop10Users().size()));
    List<Map<String, Object>> topFiles = logMapper.findFileAccessStatsGlobalTop5(); // 새 쿼리 필요
    List<Map<String, Object>> last7Days = logMapper.findAccessLogStatsLast7Days();

    ByteArrayOutputStream baos = new ByteArrayOutputStream();
    PdfWriter writer = new PdfWriter(baos);
    PdfDocument pdf = new PdfDocument(writer);
    Document document = new Document(pdf);

    // 제목
    document.add(new Paragraph("파일 접근 분석 리포트").setBold().setFontSize(18));

    // 총 접근 수
    document.add(new Paragraph("최근 30일 총 접근 수: " + totalAccess));

    // Top 5 사용자
    document.add(new Paragraph("\nTop 5 사용자"));
    Table userTable = new Table(UnitValue.createPercentArray(new float[]{2, 2})).useAllAvailableWidth();
    userTable.addHeaderCell("User ID");
    userTable.addHeaderCell("Access Count");
    for (Map<String, Object> user : topUsers) {
        userTable.addCell(user.get("user_id").toString());
        userTable.addCell(user.get("accessCount").toString());
    }
    document.add(userTable);

    // Top 5 파일
    document.add(new Paragraph("\nTop 5 파일"));
    Table fileTable = new Table(UnitValue.createPercentArray(new float[]{2, 2})).useAllAvailableWidth();
    fileTable.addHeaderCell("File ID");
    fileTable.addHeaderCell("Access Count");
    for (Map<String, Object> file : topFiles) {
        fileTable.addCell(file.get("file_id").toString());
        fileTable.addCell(file.get("count").toString());
    }
    document.add(fileTable);

    // 최근 7일 데이터 (텍스트 기반, 그래프 이미지는 차트 API 사용 시 추가 가능)
    document.add(new Paragraph("\n최근 7일 일별 접근량"));
    for (Map<String, Object> d : last7Days) {
        document.add(new Paragraph(d.get("date") + " : " + d.get("count")));
    }

    document.close();

    ByteArrayResource resource = new ByteArrayResource(baos.toByteArray());
    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"file_access_report.pdf\"")
            .contentType(MediaType.APPLICATION_PDF)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 4) **Mapper (Top 5 파일 추가)**

**경로**: `src/main/java/com/example/springbootstart/mapper/FileAccessLogMapper.java`

```java
List<Map<String, Object>> findFileAccessStatsGlobalTop5();
```

**경로**: `src/main/resources/mapper/FileAccessLogMapper.xml`

```xml
<select id="findFileAccessStatsGlobalTop5" resultType="map">
    SELECT file_id, COUNT(*) AS count
    FROM file_access_log
    GROUP BY file_id
    ORDER BY count DESC
    LIMIT 5;
</select>
```

---

#### 5) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/FileAccessLogController.java`

```java
@GetMapping("/report/pdf")
public ResponseEntity<ByteArrayResource> getPdfReport() throws IOException {
    return logService.generatePdfReport();
}
```

---

#### 6) **테스트**

**GET 요청**

```
GET /file-access-logs/report/pdf
```

**결과**

* PDF 다운로드: `file_access_report.pdf`
* PDF 내용:

  * 제목, 총 접근 수
  * Top 5 사용자 표
  * Top 5 파일 표
  * 최근 7일 일별 접근량(텍스트)

---

### 결과

* 전체 파일 접근 분석 리포트를 PDF로 자동 생성
* 관리자/보안 감사용으로 활용 가능

---

Spring Boot 시작하기 예시 100제 **완료했습니다** 🎉
필요하면 **Zip 파일** 또는 **md 파일**로 전체 정리해드릴까요?

---

#### 3) **Service (리포트 생성)**

**경로**: `src/main/java/com/example/springbootstart/service/FileAccessLogService.java`

```java
import com.itextpdf.kernel.pdf.*;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.*;
import com.itextpdf.layout.property.UnitValue;
import org.springframework.core.io.ByteArrayResource;

public ResponseEntity<ByteArrayResource> generatePdfReport() throws IOException {
    // 데이터 수집
    int totalAccess = logMapper.countAccessLogs(null, null, null, null, null); // 전체 로그 수
    List<Map<String, Object>> topUsers = logMapper.findTop10Users().subList(0, Math.min(5, logMapper.findTop10Users().size()));
    List<Map<String, Object>> topFiles = logMapper.findFileAccessStatsGlobalTop5(); // 새 쿼리 필요
    List<Map<String, Object>> last7Days = logMapper.findAccessLogStatsLast7Days();

    ByteArrayOutputStream baos = new ByteArrayOutputStream();
    PdfWriter writer = new PdfWriter(baos);
    PdfDocument pdf = new PdfDocument(writer);
    Document document = new Document(pdf);

    // 제목
    document.add(new Paragraph("파일 접근 분석 리포트").setBold().setFontSize(18));

    // 총 접근 수
    document.add(new Paragraph("최근 30일 총 접근 수: " + totalAccess));

    // Top 5 사용자
    document.add(new Paragraph("\nTop 5 사용자"));
    Table userTable = new Table(UnitValue.createPercentArray(new float[]{2, 2})).useAllAvailableWidth();
    userTable.addHeaderCell("User ID");
    userTable.addHeaderCell("Access Count");
    for (Map<String, Object> user : topUsers) {
        userTable.addCell(user.get("user_id").toString());
        userTable.addCell(user.get("accessCount").toString());
    }
    document.add(userTable);

    // Top 5 파일
    document.add(new Paragraph("\nTop 5 파일"));
    Table fileTable = new Table(UnitValue.createPercentArray(new float[]{2, 2})).useAllAvailableWidth();
    fileTable.addHeaderCell("File ID");
    fileTable.addHeaderCell("Access Count");
    for (Map<String, Object> file : topFiles) {
        fileTable.addCell(file.get("file_id").toString());
        fileTable.addCell(file.get("count").toString());
    }
    document.add(fileTable);

    // 최근 7일 데이터 (텍스트 기반, 그래프 이미지는 차트 API 사용 시 추가 가능)
    document.add(new Paragraph("\n최근 7일 일별 접근량"));
    for (Map<String, Object> d : last7Days) {
        document.add(new Paragraph(d.get("date") + " : " + d.get("count")));
    }

    document.close();

    ByteArrayResource resource = new ByteArrayResource(baos.toByteArray());
    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"file_access_report.pdf\"")
            .contentType(MediaType.APPLICATION_PDF)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 4) **Mapper (Top 5 파일 추가)**

**경로**: `src/main/java/com/example/springbootstart/mapper/FileAccessLogMapper.java`

```java
List<Map<String, Object>> findFileAccessStatsGlobalTop5();
```

**경로**: `src/main/resources/mapper/FileAccessLogMapper.xml`

```xml
<select id="findFileAccessStatsGlobalTop5" resultType="map">
    SELECT file_id, COUNT(*) AS count
    FROM file_access_log
    GROUP BY file_id
    ORDER BY count DESC
    LIMIT 5;
</select>
```

---

#### 5) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/FileAccessLogController.java`

```java
@GetMapping("/report/pdf")
public ResponseEntity<ByteArrayResource> getPdfReport() throws IOException {
    return logService.generatePdfReport();
}
```

---

#### 6) **테스트**

**GET 요청**

```
GET /file-access-logs/report/pdf
```

**결과**

* PDF 다운로드: `file_access_report.pdf`
* PDF 내용:

  * 제목, 총 접근 수
  * Top 5 사용자 표
  * Top 5 파일 표
  * 최근 7일 일별 접근량(텍스트)

---

### 결과

* 전체 파일 접근 분석 리포트를 PDF로 자동 생성
* 관리자/보안 감사용으로 활용 가능

---

Spring Boot 시작하기 예시 100제 **완료했습니다** 🎉
필요하면 **Zip 파일** 또는 **md 파일**로 전체 정리해드릴까요?
