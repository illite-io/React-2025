### 89. 게시글 + 댓글 + 첨부파일 전체 내보내기 (Zip)

---

#### 1) **목표**

* 게시글 본문 + 댓글 목록 + 첨부파일 전체를 하나의 Zip 파일로 내보내기
* 게시글 본문(`post.txt`) + 댓글(`comments.txt`) + 첨부파일 포함

---

#### 2) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/BoardService.java`

```java
import org.springframework.core.io.ByteArrayResource;
import java.util.zip.*;

public ResponseEntity<ByteArrayResource> exportBoardWithCommentsAndFiles(Long boardId) throws IOException {
    // 1) 게시글 조회
    BoardDto board = boardMapper.findBoardById(boardId);
    if (board == null) {
        return ResponseEntity.notFound().build();
    }

    // 2) 댓글 조회
    List<CommentWithUserDto> comments = boardMapper.findCommentsWithUser(boardId);

    // 3) 첨부파일 조회
    List<BoardFileDto> files = boardFileMapper.findFilesByBoardId(boardId);

    ByteArrayOutputStream byteOut = new ByteArrayOutputStream();
    try (ZipOutputStream zipOut = new ZipOutputStream(byteOut)) {
        // 게시글 본문 추가
        ZipEntry postEntry = new ZipEntry("post.txt");
        zipOut.putNextEntry(postEntry);
        String postContent = "제목: " + board.getTitle() + "\n작성자ID: " + board.getUserId() + 
                             "\n\n" + board.getContent();
        zipOut.write(postContent.getBytes());
        zipOut.closeEntry();

        // 댓글 목록 추가
        ZipEntry commentsEntry = new ZipEntry("comments.txt");
        zipOut.putNextEntry(commentsEntry);
        StringBuilder commentText = new StringBuilder();
        for (CommentWithUserDto c : comments) {
            commentText.append("작성자: ").append(c.getWriterName())
                       .append(" (ID: ").append(c.getWriterId()).append(")\n")
                       .append("내용: ").append(c.getContent()).append("\n\n");
        }
        zipOut.write(commentText.toString().getBytes());
        zipOut.closeEntry();

        // 첨부파일 추가
        for (BoardFileDto file : files) {
            Path path = Paths.get("uploads/" + file.getFilePath());
            if (!Files.exists(path)) continue;

            zipOut.putNextEntry(new ZipEntry("attachments/" + file.getFileName()));
            Files.copy(path, zipOut);
            zipOut.closeEntry();
        }
    }

    ByteArrayResource resource = new ByteArrayResource(byteOut.toByteArray());

    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"board_" + boardId + "_all.zip\"")
            .contentType(MediaType.APPLICATION_OCTET_STREAM)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 3) **Mapper (댓글 조회)**

이미 50단계에서 사용한 `findCommentsWithUser(Long boardId)` 메서드 재사용

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
import org.springframework.core.io.ByteArrayResource;

@GetMapping("/export-all/{id}")
public ResponseEntity<ByteArrayResource> exportBoardAll(@PathVariable Long id) throws IOException {
    return boardService.exportBoardWithCommentsAndFiles(id);
}
```

---

#### 5) **테스트**

**GET 요청**

```
GET /boards/export-all/1
```

**결과 (압축 파일 내용)**

* `post.txt` → 게시글 내용
* `comments.txt` → 댓글 목록
* `attachments/파일들` → 첨부파일 전체

---

### 결과

* 게시글 전체 데이터(본문 + 댓글 + 첨부파일) 일괄 백업 가능
* 프로젝트 이관, 기록 보존, 공유에 활용 가능

---

**다음 단계는 `90. 게시글 + 모든 버전 첨부파일 포함 전체 내보내기(Zip)` 입니다. 진행할까요?**
