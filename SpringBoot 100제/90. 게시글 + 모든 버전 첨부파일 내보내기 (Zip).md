### 90. 게시글 + 모든 버전 첨부파일 포함 전체 내보내기 (Zip)

---

#### 1) **목표**

* 게시글 본문 + 댓글 + 첨부파일 **현재 버전 + 모든 과거 버전**을 하나의 Zip 파일로 내보내기
* 파일 구조:

  * `post.txt` → 게시글 본문
  * `comments.txt` → 댓글
  * `attachments/` → 현재 첨부파일
  * `history/파일ID_버전번호_파일명` → 과거 버전 첨부파일

---

#### 2) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/BoardService.java`

```java
import java.util.zip.ZipOutputStream;
import java.util.zip.ZipEntry;

public ResponseEntity<ByteArrayResource> exportBoardAllVersions(Long boardId) throws IOException {
    // 1) 게시글
    BoardDto board = boardMapper.findBoardById(boardId);
    if (board == null) return ResponseEntity.notFound().build();

    // 2) 댓글
    List<CommentWithUserDto> comments = boardMapper.findCommentsWithUser(boardId);

    // 3) 현재 첨부파일
    List<BoardFileDto> files = boardFileMapper.findFilesByBoardId(boardId);

    ByteArrayOutputStream byteOut = new ByteArrayOutputStream();
    try (ZipOutputStream zipOut = new ZipOutputStream(byteOut)) {
        // 게시글 본문 추가
        zipOut.putNextEntry(new ZipEntry("post.txt"));
        String postContent = "제목: " + board.getTitle() + "\n작성자ID: " + board.getUserId() + "\n\n" + board.getContent();
        zipOut.write(postContent.getBytes());
        zipOut.closeEntry();

        // 댓글 추가
        zipOut.putNextEntry(new ZipEntry("comments.txt"));
        StringBuilder commentsText = new StringBuilder();
        for (CommentWithUserDto c : comments) {
            commentsText.append("작성자: ").append(c.getWriterName())
                        .append(" (ID: ").append(c.getWriterId()).append(")\n")
                        .append("내용: ").append(c.getContent()).append("\n\n");
        }
        zipOut.write(commentsText.toString().getBytes());
        zipOut.closeEntry();

        // 현재 첨부파일 추가
        for (BoardFileDto file : files) {
            Path path = Paths.get("uploads/" + file.getFilePath());
            if (Files.exists(path)) {
                zipOut.putNextEntry(new ZipEntry("attachments/" + file.getFileName()));
                Files.copy(path, zipOut);
                zipOut.closeEntry();
            }

            // 과거 버전 첨부파일 추가
            List<BoardFileHistoryDto> histories = boardFileMapper.findFileHistory(file.getId());
            for (BoardFileHistoryDto history : histories) {
                Path historyPath = Paths.get("uploads/" + history.getFilePath());
                if (Files.exists(historyPath)) {
                    String histName = "history/" + file.getId() + "_v" + history.getVersion() + "_" + history.getFileName();
                    zipOut.putNextEntry(new ZipEntry(histName));
                    Files.copy(historyPath, zipOut);
                    zipOut.closeEntry();
                }
            }
        }
    }

    ByteArrayResource resource = new ByteArrayResource(byteOut.toByteArray());

    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"board_" + boardId + "_full.zip\"")
            .contentType(MediaType.APPLICATION_OCTET_STREAM)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 3) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
import org.springframework.core.io.ByteArrayResource;

@GetMapping("/export-full/{id}")
public ResponseEntity<ByteArrayResource> exportBoardFull(@PathVariable Long id) throws IOException {
    return boardService.exportBoardAllVersions(id);
}
```

---

#### 4) **테스트**

**GET 요청**

```
GET /boards/export-full/1
```

**압축 파일 구조**

```
post.txt
comments.txt
attachments/file1.jpg
attachments/file2.pdf
history/10_v1_oldfile.jpg
history/10_v2_oldfile.jpg
history/11_v1_doc.pdf
```

---

### 결과

* 게시글 + 댓글 + 첨부파일 **모든 버전** 백업 가능
* 완전한 데이터 아카이브 기능 구현 완료

---

**다음 단계는 `91. 첨부파일 접근 로그 기록(다운로드/복원)` 입니다. 진행할까요?**
