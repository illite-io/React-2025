### 66. 이메일 인증 안 된 계정 로그인 차단

---

#### 1) **목표**

* 이메일 인증(`is_verified=false`)이 완료되지 않은 계정은 로그인 차단
* 사용자 경험 향상을 위해 적절한 응답 메시지 제공

---

#### 2) **DB 컬럼 확인**

이전 단계(65)에서 추가:

```sql
ALTER TABLE user ADD COLUMN is_verified BOOLEAN DEFAULT FALSE AFTER role;
```

* 가입 시 기본값 `false`, 이메일 인증 완료 시 `true`로 변경됨

---

#### 3) **UserMapper 수정**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
UserDto findByEmail(@Param("email") String email);  // 기존 있음
```

(별도 수정 필요 없음, is\_verified 컬럼은 자동 매핑)

---

#### 4) **UserService 수정 (JWT 로그인 기준)**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
public String loginWithJwt(String email, String password) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("존재하지 않는 이메일입니다.");

    // 이메일 인증 여부 확인
    if (!Boolean.TRUE.equals(user.getIsVerified())) {
        throw new RuntimeException("이메일 인증이 완료되지 않았습니다.");
    }

    if (!passwordEncoder.matches(password, user.getPassword())) {
        throw new RuntimeException("비밀번호가 일치하지 않습니다.");
    }

    return JwtUtil.generateToken(user.getEmail(), user.getRole());
}
```

---

#### 5) **UserController 수정**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/login-jwt")
public ResponseEntity<?> loginJwt(@RequestParam String email, @RequestParam String password) {
    try {
        String token = userService.loginWithJwt(email, password);
        return ResponseEntity.ok(Map.of("message", "로그인 성공", "token", token));
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(Map.of("message", e.getMessage()));
    }
}
```

---

#### 6) **테스트**

1. **이메일 인증 전 로그인**

   ```
   POST /users/login-jwt
   Body: email=test@test.com, password=1234
   ```

   **응답**

   ```json
   {
     "message": "이메일 인증이 완료되지 않았습니다."
   }
   ```

2. **이메일 인증 완료 후 로그인**

   * `GET /users/verify?token=...` 호출 → `is_verified=true`로 변경
   * 다시 로그인 요청
     **응답**

   ```json
   {
     "message": "로그인 성공",
     "token": "eyJhbGciOiJIUzI1NiJ9..."
   }
   ```

---

### 결과

* 인증되지 않은 계정 로그인 차단 완료
* 이메일 인증 완료 후 정상 로그인 가능

---

**다음 단계는 `67. 비밀번호 재설정(이메일 링크)` 입니다. 진행할까요?**
