### 82. 첨부파일 메타데이터(크기, 타입) 저장

---

#### 1) **목표**

* 첨부파일 업로드 시 **파일 크기(size)**, **MIME 타입(content type)** 메타데이터 저장
* 목록이나 상세 페이지에서 파일 정보 표시 가능

---

#### 2) **DB 테이블 수정**

**SQL**

```sql
ALTER TABLE board_file 
ADD COLUMN file_size BIGINT AFTER file_path,
ADD COLUMN content_type VARCHAR(100) AFTER file_size;
```

---

#### 3) **DTO 수정**

**경로**: `src/main/java/com/example/springbootstart/dto/BoardFileDto.java`

```java
@Getter
@Setter
public class BoardFileDto {
    private Long id;
    private Long boardId;
    private String fileName;
    private String filePath;
    private String thumbnailPath;
    private Long fileSize;        // 추가
    private String contentType;   // 추가
    private String createdAt;
}
```

---

#### 4) **Mapper 수정**

**경로**: `src/main/resources/mapper/BoardFileMapper.xml`

```xml
<insert id="insertBoardFile" parameterType="com.example.springbootstart.dto.BoardFileDto">
    INSERT INTO board_file (board_id, file_name, file_path, thumbnail_path, file_size, content_type)
    VALUES (#{boardId}, #{fileName}, #{filePath}, #{thumbnailPath}, #{fileSize}, #{contentType})
</insert>
```

---

#### 5) **Service 업로드 로직 수정**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
@Transactional
public void saveBoardFileWithMetadata(BoardFileDto dto, MultipartFile file) throws Exception {
    // 1) 원본 파일 저장
    String folder = "uploads/files/";
    String filename = UUID.randomUUID() + "_" + file.getOriginalFilename();
    Path path = Paths.get(folder + filename);
    Files.createDirectories(path.getParent());
    file.transferTo(path.toFile());

    // 2) 기본 메타데이터 설정
    dto.setFileName(file.getOriginalFilename());
    dto.setFilePath("files/" + filename);
    dto.setFileSize(file.getSize());
    dto.setContentType(file.getContentType());

    // 3) 이미지 파일인 경우 썸네일 생성
    if (file.getContentType() != null && file.getContentType().startsWith("image")) {
        String thumbFolder = "uploads/thumbs/";
        Files.createDirectories(Paths.get(thumbFolder));
        String thumbName = "thumb_" + filename;
        String thumbPath = thumbFolder + thumbName;
        ImageUtil.createThumbnail(path.toString(), thumbPath, 200, 200);
        dto.setThumbnailPath("thumbs/" + thumbName);
    }

    boardFileMapper.insertBoardFile(dto);
}
```

---

#### 6) **Controller**

기존 업로드 시 서비스 호출을 `saveBoardFileWithMetadata()`로 교체:

```java
@PostMapping("/upload")
public ResponseEntity<?> uploadFiles(@RequestParam("boardId") Long boardId,
                                     @RequestParam("files") List<MultipartFile> files) {
    try {
        List<String> uploaded = new ArrayList<>();
        for (MultipartFile file : files) {
            if (file.isEmpty()) continue;
            BoardFileDto dto = new BoardFileDto();
            dto.setBoardId(boardId);
            boardFileService.saveBoardFileWithMetadata(dto, file);
            uploaded.add(file.getOriginalFilename());
        }
        return ResponseEntity.ok(Map.of("uploaded", uploaded));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}
```

---

#### 7) **테스트**

**POST 업로드 요청**

```
POST /board-files/upload
Form-data:
- boardId: 1
- files: (PDF, JPG)
```

**DB 확인**

```sql
SELECT file_name, file_size, content_type FROM board_file;
```

→ 예시 결과:

```
"report.pdf"   12045   "application/pdf"
"image.jpg"    30567   "image/jpeg"
```

---

#### 8) **응답 활용**

* UI에서 파일 크기(KB/MB 변환), 아이콘(파일 타입별) 표시 가능
* 이미지 여부를 빠르게 구분 가능

---

### 결과

* 첨부파일의 크기와 MIME 타입 메타데이터가 DB에 저장
* 파일 정보 표시 및 필터링 기능 구현에 활용 가능

---

**다음 단계는 `83. 첨부파일 다운로드 시 Content-Type 적용` 입니다. 진행할까요?**
