### 91. 첨부파일 접근 로그 기록 (다운로드/복원)

---

#### 1) **목표**

* 첨부파일 다운로드 및 복원 시 접근 로그 기록
* 사용자 ID, 파일 ID, 작업 유형(다운로드/복원), 시간 기록
* 향후 보안 감사(Audit) 또는 사용량 분석에 활용

---

#### 2) **DB 테이블 생성**

**SQL**

```sql
CREATE TABLE file_access_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    file_id BIGINT NOT NULL,
    user_id BIGINT,
    action_type VARCHAR(20),  -- DOWNLOAD, RESTORE
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

#### 3) **DTO**

**경로**: `src/main/java/com/example/springbootstart/dto/FileAccessLogDto.java`

```java
package com.example.springbootstart.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class FileAccessLogDto {
    private Long id;
    private Long fileId;
    private Long userId;
    private String actionType;
    private String accessTime;
}
```

---

#### 4) **Mapper**

**경로**: `src/main/java/com/example/springbootstart/mapper/FileAccessLogMapper.java`

```java
import com.example.springbootstart.dto.FileAccessLogDto;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface FileAccessLogMapper {
    int insertAccessLog(FileAccessLogDto log);
}
```

**경로**: `src/main/resources/mapper/FileAccessLogMapper.xml`

```xml
<mapper namespace="com.example.springbootstart.mapper.FileAccessLogMapper">
    <insert id="insertAccessLog" parameterType="com.example.springbootstart.dto.FileAccessLogDto">
        INSERT INTO file_access_log (file_id, user_id, action_type)
        VALUES (#{fileId}, #{userId}, #{actionType})
    </insert>
</mapper>
```

---

#### 5) **Service (로그 기록 함수 추가)**

**경로**: `src/main/java/com/example/springbootstart/service/FileAccessLogService.java`

```java
import com.example.springbootstart.dto.FileAccessLogDto;
import com.example.springbootstart.mapper.FileAccessLogMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class FileAccessLogService {
    private final FileAccessLogMapper logMapper;

    public FileAccessLogService(FileAccessLogMapper logMapper) {
        this.logMapper = logMapper;
    }

    @Transactional
    public void logAccess(Long fileId, Long userId, String actionType) {
        FileAccessLogDto log = new FileAccessLogDto();
        log.setFileId(fileId);
        log.setUserId(userId);
        log.setActionType(actionType);
        logMapper.insertAccessLog(log);
    }
}
```

---

#### 6) **다운로드 / 복원 시 로그 기록**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
public ResponseEntity<Resource> downloadFileWithLog(Long fileId, Long userId) {
    // 다운로드 기존 처리
    ResponseEntity<Resource> response = downloadFileWithContentType(fileId);

    // 로그 기록
    fileAccessLogService.logAccess(fileId, userId, "DOWNLOAD");
    return response;
}

@Transactional
public void restoreFileVersion(Long fileId, int version, Long userId) throws Exception {
    // 기존 복원 처리
    restoreFileVersion(fileId, version);
    // 로그 기록
    fileAccessLogService.logAccess(fileId, userId, "RESTORE");
}
```

---

#### 7) **Controller 수정**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardFileController.java`

```java
@GetMapping("/download/{fileId}")
public ResponseEntity<Resource> downloadFile(@PathVariable Long fileId,
                                             @RequestParam Long userId) {
    return boardFileService.downloadFileWithLog(fileId, userId);
}

@PostMapping("/restore/{fileId}/{version}")
public ResponseEntity<?> restoreFileVersion(@PathVariable Long fileId,
                                            @PathVariable int version,
                                            @RequestParam Long userId) {
    try {
        boardFileService.restoreFileVersion(fileId, version, userId);
        return ResponseEntity.ok(Map.of("message", "파일 버전 복원 완료"));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}
```

---

#### 8) **테스트**

1. 파일 다운로드 요청

   ```
   GET /board-files/download/10?userId=5
   ```

   → 로그 테이블 확인:

   ```
   SELECT * FROM file_access_log WHERE file_id=10;
   ```

   ```
   file_id=10, user_id=5, action_type=DOWNLOAD
   ```

2. 파일 복원 요청

   ```
   POST /board-files/restore/10/1?userId=5
   ```

   → 로그 테이블 확인:

   ```
   file_id=10, user_id=5, action_type=RESTORE
   ```

---

### 결과

* 파일 다운로드/복원 시 접근 로그 자동 기록
* 파일 이력 추적 및 보안 감사 가능

---

**다음 단계는 `92. 파일 접근 로그 조회(필터링)` 입니다. 진행할까요?**
