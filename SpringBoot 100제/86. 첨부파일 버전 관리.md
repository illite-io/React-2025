### 86. 첨부파일 버전 관리 (히스토리)

---

#### 1) **목표**

* 첨부파일 교체 또는 수정 시 **이전 버전을 보존**
* 변경 이력 조회 가능
* 주요 사용 사례: 중요 문서 변경 추적

---

#### 2) **DB 테이블 설계**

**새 테이블: `board_file_history`**

```sql
CREATE TABLE board_file_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    board_file_id BIGINT NOT NULL,
    version INT NOT NULL,
    file_name VARCHAR(255),
    file_path VARCHAR(255),
    thumbnail_path VARCHAR(255),
    file_size BIGINT,
    content_type VARCHAR(100),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (board_file_id) REFERENCES board_file(id) ON DELETE CASCADE
);
```

* `version`: 파일 변경 횟수 (1,2,3...)
* 파일 삭제 시 히스토리 자동 삭제

---

#### 3) **DTO**

**경로**: `src/main/java/com/example/springbootstart/dto/BoardFileHistoryDto.java`

```java
package com.example.springbootstart.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class BoardFileHistoryDto {
    private Long id;
    private Long boardFileId;
    private int version;
    private String fileName;
    private String filePath;
    private String thumbnailPath;
    private Long fileSize;
    private String contentType;
    private String changedAt;
}
```

---

#### 4) **Mapper**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardFileMapper.java`

```java
int insertFileHistory(BoardFileHistoryDto dto);
List<BoardFileHistoryDto> findFileHistory(Long boardFileId);
int findMaxVersion(Long boardFileId);
```

**Mapper XML**
**경로**: `src/main/resources/mapper/BoardFileMapper.xml`

```xml
<select id="findMaxVersion" parameterType="long" resultType="int">
    SELECT COALESCE(MAX(version), 0) FROM board_file_history WHERE board_file_id = #{boardFileId}
</select>

<insert id="insertFileHistory" parameterType="com.example.springbootstart.dto.BoardFileHistoryDto">
    INSERT INTO board_file_history
        (board_file_id, version, file_name, file_path, thumbnail_path, file_size, content_type)
    VALUES
        (#{boardFileId}, #{version}, #{fileName}, #{filePath}, #{thumbnailPath}, #{fileSize}, #{contentType})
</insert>

<select id="findFileHistory" parameterType="long" resultType="com.example.springbootstart.dto.BoardFileHistoryDto">
    SELECT * FROM board_file_history 
    WHERE board_file_id = #{boardFileId} 
    ORDER BY version DESC
</select>
```

---

#### 5) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
@Transactional
public void replaceFileWithHistory(Long fileId, MultipartFile newFile) throws Exception {
    // 1) 기존 파일 조회
    BoardFileDto oldFile = boardFileMapper.findFileById(fileId);
    if (oldFile == null) throw new RuntimeException("파일을 찾을 수 없습니다.");

    // 2) 버전 이력 추가
    int maxVersion = boardFileMapper.findMaxVersion(fileId);
    BoardFileHistoryDto history = new BoardFileHistoryDto();
    history.setBoardFileId(fileId);
    history.setVersion(maxVersion + 1);
    history.setFileName(oldFile.getFileName());
    history.setFilePath(oldFile.getFilePath());
    history.setThumbnailPath(oldFile.getThumbnailPath());
    history.setFileSize(oldFile.getFileSize());
    history.setContentType(oldFile.getContentType());
    boardFileMapper.insertFileHistory(history);

    // 3) 새 파일 저장 (메타데이터 포함)
    BoardFileDto updatedFile = new BoardFileDto();
    updatedFile.setId(fileId);
    updatedFile.setBoardId(oldFile.getBoardId());
    saveBoardFileWithMetadata(updatedFile, newFile); // 기존 파일 업로드 로직 사용

    // 4) 기존 실제 파일 삭제
    Path path = Paths.get("uploads/" + oldFile.getFilePath());
    Files.deleteIfExists(path);
}
```

---

#### 6) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardFileController.java`

```java
@PutMapping("/replace/{fileId}")
public ResponseEntity<?> replaceFile(@PathVariable Long fileId,
                                     @RequestParam("file") MultipartFile file) {
    try {
        boardFileService.replaceFileWithHistory(fileId, file);
        return ResponseEntity.ok(Map.of("message", "파일이 교체되고 히스토리가 저장되었습니다."));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}

@GetMapping("/history/{fileId}")
public ResponseEntity<?> getFileHistory(@PathVariable Long fileId) {
    return ResponseEntity.ok(boardFileMapper.findFileHistory(fileId));
}
```

---

#### 7) **테스트**

1. **파일 교체**

   ```
   PUT /board-files/replace/10
   Form-data: file=(새로운 파일)
   ```

   → 기존 파일 삭제, DB에 버전 히스토리 저장

2. **히스토리 조회**

   ```
   GET /board-files/history/10
   ```

   **응답**

   ```json
   [
     { "version": 2, "fileName": "old_v2.docx", "changedAt": "2025-08-03T12:40:00" },
     { "version": 1, "fileName": "old_v1.docx", "changedAt": "2025-08-02T11:30:00" }
   ]
   ```

---

### 결과

* 파일 교체 시 이전 버전 자동 보존
* 변경 이력 조회 가능 → 중요 문서나 이미지 관리에 유용

---

**다음 단계는 `87. 첨부파일 히스토리 특정 버전 복원` 입니다. 진행할까요?**
