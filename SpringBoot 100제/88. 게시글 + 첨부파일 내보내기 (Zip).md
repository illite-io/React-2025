### 88. 게시글 + 첨부파일 전체 내보내기 (Zip)

---

#### 1) **목표**

* 게시글 내용 + 첨부파일 전체를 **하나의 Zip 파일**로 내보내기
* 게시글 본문은 `post.txt` 파일로 저장하고 첨부파일과 함께 압축

---

#### 2) **Service**

**경로**: `src/main/java/com/example/springbootstart/service/BoardService.java`

```java
import org.springframework.core.io.ByteArrayResource;
import java.util.zip.*;

public ResponseEntity<ByteArrayResource> exportBoardWithFiles(Long boardId) throws IOException {
    // 1) 게시글 조회
    BoardDto board = boardMapper.findBoardById(boardId);
    if (board == null) {
        return ResponseEntity.notFound().build();
    }

    // 2) 첨부파일 조회
    List<BoardFileDto> files = boardFileMapper.findFilesByBoardId(boardId);

    ByteArrayOutputStream byteOut = new ByteArrayOutputStream();
    try (ZipOutputStream zipOut = new ZipOutputStream(byteOut)) {
        // 3) 게시글 본문 파일 추가
        ZipEntry textEntry = new ZipEntry("post.txt");
        zipOut.putNextEntry(textEntry);
        String content = "제목: " + board.getTitle() + "\n\n" + board.getContent();
        zipOut.write(content.getBytes());
        zipOut.closeEntry();

        // 4) 첨부파일 추가
        for (BoardFileDto file : files) {
            Path path = Paths.get("uploads/" + file.getFilePath());
            if (!Files.exists(path)) continue;

            zipOut.putNextEntry(new ZipEntry(file.getFileName()));
            Files.copy(path, zipOut);
            zipOut.closeEntry();
        }
    }

    ByteArrayResource resource = new ByteArrayResource(byteOut.toByteArray());

    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"board_" + boardId + ".zip\"")
            .contentType(MediaType.APPLICATION_OCTET_STREAM)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 3) **Mapper (게시글 단일 조회 추가)**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardMapper.java`

```java
BoardDto findBoardById(Long id);
```

**경로**: `src/main/resources/mapper/BoardMapper.xml`

```xml
<select id="findBoardById" parameterType="long" resultType="com.example.springbootstart.dto.BoardDto">
    SELECT * FROM board WHERE id = #{id}
</select>
```

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
import org.springframework.core.io.ByteArrayResource;

@GetMapping("/export/{id}")
public ResponseEntity<ByteArrayResource> exportBoard(@PathVariable Long id) throws IOException {
    return boardService.exportBoardWithFiles(id);
}
```

---

#### 5) **테스트**

**GET 요청**

```
GET /boards/export/1
```

**결과**

* `board_1.zip` 다운로드
* 압축 내용:

  * `post.txt`: 게시글 제목 + 내용
  * 첨부파일 전체 포함

---

### 결과

* 게시글 + 첨부파일 전체 내보내기 가능
* 데이터 백업 및 공유 용도로 활용 가능

---

**다음 단계는 `89. 게시글 + 댓글 + 첨부파일 전체 내보내기(Zip)` 입니다. 진행할까요?**
