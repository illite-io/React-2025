### 95. 파일 접근 로그 CSV 다운로드

---

#### 1) **목표**

* 파일 접근 로그를 **CSV 형식**으로 다운로드
* 조건 필터링(파일 ID, 사용자 ID, 액션타입, 날짜 범위) 지원

---

#### 2) **Service (CSV 생성)**

**경로**: `src/main/java/com/example/springbootstart/service/FileAccessLogService.java`

```java
import java.nio.charset.StandardCharsets;

public ResponseEntity<ByteArrayResource> exportLogsToCsv(Long fileId, Long userId, String actionType,
                                                         String startDate, String endDate) {
    List<FileAccessLogDto> logs = logMapper.findAccessLogs(Map.of(
            "fileId", fileId,
            "userId", userId,
            "actionType", actionType,
            "startDate", startDate,
            "endDate", endDate
    ));

    StringBuilder csv = new StringBuilder();
    // Header
    csv.append("File ID,User ID,Action,Access Time\n");
    // Data
    for (FileAccessLogDto log : logs) {
        csv.append(log.getFileId()).append(",")
           .append(log.getUserId() != null ? log.getUserId() : "").append(",")
           .append(log.getActionType()).append(",")
           .append(log.getAccessTime()).append("\n");
    }

    byte[] csvBytes = csv.toString().getBytes(StandardCharsets.UTF_8);
    ByteArrayResource resource = new ByteArrayResource(csvBytes);

    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"file_access_logs.csv\"")
            .contentType(MediaType.TEXT_PLAIN)
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 3) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/FileAccessLogController.java`

```java
@GetMapping("/csv")
public ResponseEntity<ByteArrayResource> downloadCsv(
        @RequestParam(required = false) Long fileId,
        @RequestParam(required = false) Long userId,
        @RequestParam(required = false) String actionType,
        @RequestParam(required = false) String startDate,
        @RequestParam(required = false) String endDate) {
    return logService.exportLogsToCsv(fileId, userId, actionType, startDate, endDate);
}
```

---

#### 4) **테스트**

**GET 요청**

```
GET /file-access-logs/csv?actionType=DOWNLOAD
```

**결과**

* 다운로드된 파일: `file_access_logs.csv`
* CSV 내용 예시:

```
File ID,User ID,Action,Access Time
10,5,DOWNLOAD,2025-08-03T12:30:00
10,5,RESTORE,2025-08-03T12:31:00
```

---

### 결과

* 파일 접근 로그 CSV 다운로드 가능
* Excel보다 가볍고 데이터 처리(ETL, 분석) 작업에 유용

---

**다음 단계는 `96. 파일 접근 로그 대시보드(최근 7일 그래프)` 입니다. 진행할까요?**
