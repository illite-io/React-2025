### 64. JWT + 사용자 권한(Role) 적용

---

#### 1) **목표**

* 사용자 권한(예: `ROLE_USER`, `ROLE_ADMIN`)을 JWT에 포함
* API 접근 시 권한 체크 수행

---

#### 2) **테이블 변경 (role 컬럼 추가)**

**SQL**

```sql
ALTER TABLE user ADD COLUMN role VARCHAR(20) DEFAULT 'ROLE_USER' AFTER password;
```

---

#### 3) **DTO 수정**

**경로**: `src/main/java/com/example/springbootstart/dto/UserDto.java`

```java
@Getter
@Setter
@ToString
public class UserDto {
    private Long id;
    private String name;
    private int age;
    private String email;
    private String password;
    private String role;       // 사용자 권한
    private String createdAt;
    private String updatedAt;
}
```

---

#### 4) **JWT 유틸 수정 (권한 포함)**

**경로**: `src/main/java/com/example/springbootstart/util/JwtUtil.java`

```java
public static String generateToken(String email, String role) {
    return Jwts.builder()
            .setSubject(email)
            .claim("role", role)  // 권한 claim 추가
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
            .signWith(key)
            .compact();
}

public static String getRoleFromToken(String token) {
    return Jwts.parserBuilder()
            .setSigningKey(key)
            .build()
            .parseClaimsJws(token)
            .getBody()
            .get("role", String.class);
}
```

---

#### 5) **로그인 시 JWT 발급 변경**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
public String loginWithJwt(String email, String password) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("존재하지 않는 이메일입니다.");
    if (!passwordEncoder.matches(password, user.getPassword()))
        throw new RuntimeException("비밀번호가 일치하지 않습니다.");

    // 권한 포함 토큰 발급
    return JwtUtil.generateToken(user.getEmail(), user.getRole());
}
```

---

#### 6) **권한 체크용 어노테이션 생성**

**경로**: `src/main/java/com/example/springbootstart/annotation/RoleRequired.java`

```java
package com.example.springbootstart.annotation;

import java.lang.annotation.*;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RoleRequired {
    String value(); // 요구하는 권한
}
```

---

#### 7) **권한 체크 AOP**

**경로**: `src/main/java/com/example/springbootstart/config/RoleCheckAspect.java`

```java
package com.example.springbootstart.config;

import com.example.springbootstart.annotation.RoleRequired;
import com.example.springbootstart.util.JwtUtil;
import io.jsonwebtoken.JwtException;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ResponseStatusException;

import javax.servlet.http.HttpServletRequest;

@Aspect
@Component
public class RoleCheckAspect {

    private final HttpServletRequest request;

    public RoleCheckAspect(HttpServletRequest request) {
        this.request = request;
    }

    @Before("@annotation(roleRequired)")
    public void checkRole(JoinPoint joinPoint, RoleRequired roleRequired) {
        String authHeader = request.getHeader("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer "))
            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, "토큰이 없습니다.");

        String token = authHeader.substring(7);
        try {
            String role = JwtUtil.getRoleFromToken(token);
            if (!role.equals(roleRequired.value())) {
                throw new ResponseStatusException(HttpStatus.FORBIDDEN, "권한이 없습니다.");
            }
        } catch (JwtException e) {
            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, "유효하지 않은 토큰");
        }
    }
}
```

---

#### 8) **Controller에서 관리자 전용 API 예시**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
import com.example.springbootstart.annotation.RoleRequired;

@DeleteMapping("/admin/{id}")
@RoleRequired("ROLE_ADMIN")
public ResponseEntity<?> adminDeleteBoard(@PathVariable Long id) {
    int result = boardService.deleteBoard(id);
    return result == 1 ? ResponseEntity.ok(Map.of("message", "관리자 삭제 성공"))
                       : ResponseEntity.notFound().build();
}
```

---

#### 9) **테스트**

1. **일반 사용자 JWT 발급**

   ```
   POST /users/login-jwt
   → 토큰: role=ROLE_USER
   ```

2. **관리자 전용 삭제 호출**

   ```
   DELETE /boards/admin/1
   Authorization: Bearer <ROLE_USER 토큰>
   ```

   **응답**: `403 권한이 없습니다.`

3. **관리자 JWT 발급(ROLE\_ADMIN)**

   * DB에서 사용자 role을 `ROLE_ADMIN`으로 업데이트
   * 다시 로그인 → 토큰 발급

   ```
   DELETE /boards/admin/1
   Authorization: Bearer <ROLE_ADMIN 토큰>
   ```

   **응답**

   ```json
   { "message": "관리자 삭제 성공" }
   ```

---

### 결과

* JWT 토큰에 **권한 정보 포함**
* AOP를 활용해 특정 API 접근 시 권한 검증

---

**다음 단계는 `65. 회원가입 이메일 인증(토큰 발송)` 입니다. 진행할까요?**
