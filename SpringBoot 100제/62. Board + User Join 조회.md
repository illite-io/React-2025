### 62. 비밀번호 암호화 (BCrypt)

---

#### 1) **목표**

* 사용자 비밀번호를 DB에 평문으로 저장하지 않고 **BCrypt 해시** 처리
* 로그인 시 입력한 비밀번호를 해시 값과 비교

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

> Spring Security 전체 기능을 쓰진 않지만 **BCryptPasswordEncoder**만 사용 가능

---

#### 3) **설정 클래스 작성**

**경로**: `src/main/java/com/example/springbootstart/config/PasswordEncoderConfig.java`

```java
package com.example.springbootstart.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordEncoderConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

---

#### 4) **회원 가입 시 암호화 적용**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
import org.springframework.security.crypto.password.PasswordEncoder;

@Service
public class UserService {
    private final UserMapper userMapper;
    private final PasswordEncoder passwordEncoder;

    public UserService(UserMapper userMapper, PasswordEncoder passwordEncoder) {
        this.userMapper = userMapper;
        this.passwordEncoder = passwordEncoder;
    }

    @Transactional
    public int registerUser(UserDto userDto) {
        if (isEmailDuplicated(userDto.getEmail())) {
            throw new RuntimeException("이미 사용 중인 이메일입니다.");
        }
        // 비밀번호 암호화
        String encodedPassword = passwordEncoder.encode(userDto.getPassword());
        userDto.setPassword(encodedPassword);

        return userMapper.insertUser(userDto);
    }
}
```

---

#### 5) **로그인 시 비밀번호 비교**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
public UserDto login(String email, String password, HttpSession session) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("존재하지 않는 이메일입니다.");

    // 비밀번호 해시 비교
    if (!passwordEncoder.matches(password, user.getPassword())) {
        throw new RuntimeException("비밀번호가 일치하지 않습니다.");
    }

    session.setAttribute("loginUser", user);
    return user;
}
```

---

#### 6) **테스트**

1. **회원가입**

   ```
   POST http://localhost:8080/users/register
   Body(JSON)
   {
       "name": "홍길동",
       "age": 30,
       "email": "hong@test.com",
       "password": "1234"
   }
   ```

   → DB에 저장된 비밀번호가 해시 형태여야 함 (예: `$2a$10$...`)

2. **로그인**

   ```
   POST http://localhost:8080/users/login
   Body(x-www-form-urlencoded)
   email=hong@test.com&password=1234
   ```

   → 정상 로그인 성공

---

#### 7) **결과**

* 비밀번호가 해시 처리되어 안전하게 저장
* 로그인 시 평문 비밀번호를 비교하지 않고 해시 값으로 인증

---

**다음 단계는 `63. JWT(Json Web Token) 로그인` 입니다. 진행할까요?**
