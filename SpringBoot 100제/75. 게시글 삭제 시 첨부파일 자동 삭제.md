### 75. 게시글 삭제 시 첨부파일 자동 삭제

---

#### 1) **목표**

* 게시글 삭제 시 해당 게시글의 첨부파일도 함께 삭제
* DB와 실제 서버 파일 모두 정리

---

#### 2) **BoardService 수정**

**경로**: `src/main/java/com/example/springbootstart/service/BoardService.java`

```java
import java.nio.file.*;

@Transactional
public int deleteBoardWithFiles(Long boardId) {
    // 1) 첨부파일 조회
    List<BoardFileDto> files = boardFileMapper.findFilesByBoardId(boardId);

    // 2) DB에서 게시글 삭제 (ON DELETE CASCADE로 board_file 자동 삭제되도록 설정되어 있어야 함)
    int result = boardMapper.deleteBoard(boardId);

    if (result == 1) {
        // 3) 실제 파일 삭제
        for (BoardFileDto file : files) {
            Path path = Paths.get("uploads/" + file.getFilePath());
            try {
                Files.deleteIfExists(path);
            } catch (Exception e) {
                // 로그 처리 (강제 예외는 발생시키지 않음)
                e.printStackTrace();
            }
        }
    }
    return result;
}
```

---

#### 3) **BoardMapper (기존 삭제 사용)**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardMapper.java`

```java
int deleteBoard(Long id);  // 이미 작성되어 있음
```

**Mapper XML (기존)**

```xml
<delete id="deleteBoard" parameterType="long">
    DELETE FROM board WHERE id = #{id}
</delete>
```

> **참고:** `board_file` 테이블 생성 시 `FOREIGN KEY(board_id) REFERENCES board(id) ON DELETE CASCADE` 설정되어 있어야 DB 자동 삭제 지원됨.
> 없다면 `board_file` 수동 삭제 필요:

```java
boardFileMapper.deleteFilesByBoardId(boardId);
```

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
@DeleteMapping("/{id}")
public ResponseEntity<?> deleteBoardWithFiles(@PathVariable Long id) {
    int result = boardService.deleteBoardWithFiles(id);
    return result == 1
            ? ResponseEntity.ok(Map.of("message", "게시글 및 첨부파일 삭제 성공"))
            : ResponseEntity.status(404).body(Map.of("message", "게시글을 찾을 수 없습니다."));
}
```

---

#### 5) **테스트**

**DELETE 요청**

```
DELETE /boards/1
```

**응답**

```json
{
  "message": "게시글 및 첨부파일 삭제 성공"
}
```

**DB 확인**

```sql
SELECT * FROM board_file WHERE board_id = 1;
```

→ 데이터가 없어야 함

**서버 확인**

* `uploads/files/` 해당 게시글 관련 파일 삭제됨

---

### 결과

* 게시글 삭제 시 첨부파일 자동 삭제 완료
* DB 정합성과 서버 파일 정리 보장

---

**다음 단계는 `76. 첨부파일 다운로드 (개별)` 입니다. 진행할까요?**
