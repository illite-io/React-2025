### 61. 인터셉터(HandlerInterceptor)로 로그인 공통 검사

---

#### 1) **목표**

* **모든 게시글 작성, 수정, 삭제 요청** 시 공통적으로 로그인 여부 체크
* Controller마다 세션 검사를 반복하지 않고 **Interceptor**에서 처리

---

#### 2) **인터셉터 클래스 작성**

**경로**: `src/main/java/com/example/springbootstart/config/LoginInterceptor.java`

```java
package com.example.springbootstart.config;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.web.servlet.HandlerInterceptor;

public class LoginInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("loginUser") == null) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setContentType("application/json;charset=UTF-8");
            response.getWriter().write("{\"message\": \"로그인이 필요합니다.\"}");
            return false; // Controller 진입 차단
        }
        return true;
    }
}
```

---

#### 3) **인터셉터 등록**

**경로**: `src/main/java/com/example/springbootstart/config/WebConfig.java`

```java
package com.example.springbootstart.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/boards/**")   // 게시글 관련 요청
                .excludePathPatterns("/boards", "/boards/*", "/boards/search", "/boards/page",
                                     "/boards/detail/**", "/boards/with-comment-count"); 
        // GET(조회) 요청은 제외
    }
}
```

---

#### 4) **Controller에서 세션 체크 제거**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
@PostMapping
public ResponseEntity<?> createBoard(@RequestBody BoardDto boardDto, HttpSession session) {
    // 로그인 체크는 인터셉터에서 이미 처리
    UserDto user = (UserDto) session.getAttribute("loginUser");
    boardDto.setUserId(user.getId());

    int result = boardService.createBoard(boardDto);
    return result == 1
            ? ResponseEntity.ok(Map.of("message", "게시글 등록 성공"))
            : ResponseEntity.badRequest().body(Map.of("message", "게시글 등록 실패"));
}
```

---

#### 5) **테스트 요청**

1. **로그인 없이 작성 요청**

   ```
   POST http://localhost:8080/boards
   ```

   **응답**

   ```json
   {
       "message": "로그인이 필요합니다."
   }
   ```

   (HTTP 상태코드: 401)

2. **로그인 후 작성 요청**

   * `POST /users/login` → 세션 저장
   * 이후 `POST /boards` 호출
     **응답**

   ```json
   {
       "message": "게시글 등록 성공"
   }
   ```

---

#### 6) **결과**

* 공통 로그인 체크 로직을 인터셉터로 이동 → Controller 코드 간결화
* 관리 포인트가 줄어 유지보수 용이

---

**다음 단계는 `62. 비밀번호 암호화(BCrypt)` 입니다. 진행할까요?**
