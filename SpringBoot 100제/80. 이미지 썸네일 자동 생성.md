### 80. 이미지 썸네일 자동 생성 (리사이즈)

---

#### 1) **목표**

* 이미지 업로드 시 원본 외에 **썸네일(작은 사이즈)** 자동 생성
* 목록 조회 시 썸네일 경로 제공 → 빠른 로딩

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>net.coobird</groupId>
    <artifactId>thumbnailator</artifactId>
    <version>0.4.20</version>
</dependency>
```

> **Thumbnailator** 라이브러리 사용 → 간단한 이미지 리사이즈 지원

---

#### 3) **썸네일 생성 메서드**

**경로**: `src/main/java/com/example/springbootstart/util/ImageUtil.java`

```java
package com.example.springbootstart.util;

import net.coobird.thumbnailator.Thumbnails;
import java.io.File;
import java.io.IOException;

public class ImageUtil {
    public static String createThumbnail(String sourcePath, String thumbPath, int width, int height) throws IOException {
        Thumbnails.of(new File(sourcePath))
                  .size(width, height)
                  .toFile(new File(thumbPath));
        return thumbPath;
    }
}
```

---

#### 4) **파일 업로드 로직 수정 (썸네일 생성)**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
import com.example.springbootstart.util.ImageUtil;

@Transactional
public void saveBoardFileWithThumbnail(BoardFileDto dto, MultipartFile file) throws Exception {
    // 1) 원본 파일 저장
    String folder = "uploads/files/";
    String filename = UUID.randomUUID() + "_" + file.getOriginalFilename();
    Path path = Paths.get(folder + filename);
    Files.createDirectories(path.getParent());
    file.transferTo(path.toFile());

    dto.setFileName(file.getOriginalFilename());
    dto.setFilePath("files/" + filename);

    // 2) 이미지 파일인 경우 썸네일 생성
    if (file.getContentType() != null && file.getContentType().startsWith("image")) {
        String thumbFolder = "uploads/thumbs/";
        Files.createDirectories(Paths.get(thumbFolder));
        String thumbName = "thumb_" + filename;
        String thumbPath = thumbFolder + thumbName;
        ImageUtil.createThumbnail(path.toString(), thumbPath, 200, 200);
        dto.setThumbnailPath("thumbs/" + thumbName); // DB에 썸네일 경로 저장 필요
    } else {
        dto.setThumbnailPath(null);
    }

    boardFileMapper.insertBoardFile(dto);
}
```

---

#### 5) **BoardFileDto 수정**

**경로**: `src/main/java/com/example/springbootstart/dto/BoardFileDto.java`

```java
@Getter
@Setter
public class BoardFileDto {
    private Long id;
    private Long boardId;
    private String fileName;
    private String filePath;
    private String thumbnailPath;  // 추가된 필드
    private String createdAt;
}
```

---

#### 6) **Mapper 수정**

**경로**: `src/main/resources/mapper/BoardFileMapper.xml`

```xml
<insert id="insertBoardFile" parameterType="com.example.springbootstart.dto.BoardFileDto">
    INSERT INTO board_file (board_id, file_name, file_path, thumbnail_path)
    VALUES (#{boardId}, #{fileName}, #{filePath}, #{thumbnailPath})
</insert>
```

---

#### 7) **Controller 수정 (기존 업로드)**

기존 업로드 로직에서 `saveBoardFile()` 대신 `saveBoardFileWithThumbnail()` 호출:

```java
for (MultipartFile file : files) {
    BoardFileDto dto = new BoardFileDto();
    dto.setBoardId(boardId);
    boardFileService.saveBoardFileWithThumbnail(dto, file);
}
```

---

#### 8) **정적 리소스 경로 추가**

**경로**: `WebConfig.java`

```java
registry.addResourceHandler("/thumbs/**")
        .addResourceLocations("file:uploads/thumbs/");
```

---

#### 9) **테스트**

1. **이미지 업로드**
   → `uploads/files/` 원본 저장
   → `uploads/thumbs/` 썸네일 자동 생성
2. **DB 확인**

   ```
   SELECT file_path, thumbnail_path FROM board_file;
   ```

   → `thumbnail_path`에 경로 저장
3. **브라우저 접근**

   ```
   http://localhost:8080/thumbs/thumb_파일명.jpg
   ```

---

### 결과

* 이미지 업로드 시 썸네일 자동 생성
* 목록 조회 시 빠른 로딩 가능 (썸네일 경로 사용)

---

**다음 단계는 `81. 사용자 프로필 썸네일 별도 관리` 입니다. 진행할까요?**
