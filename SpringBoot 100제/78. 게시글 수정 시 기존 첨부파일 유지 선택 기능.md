### 78. 게시글 수정 시 기존 첨부파일 유지 선택 기능

---

#### 1) **목표**

* 게시글 수정 시 **기존 첨부파일 중 일부만 삭제**하고 나머지는 유지
* 새 첨부파일 추가 가능
* 기존에는 전체 교체(71단계)였으나 → **부분 유지 + 부분 삭제 + 새 파일 추가** 지원

---

#### 2) **프론트엔드 요청 형태 예시**

* 유지할 파일 ID 목록(`keepFileIds`)
* 새로 업로드할 파일(`files`)

**예시 요청**

```
PUT /boards/1/update-with-files
Form-data:
- title: 새 제목
- content: 새 내용
- keepFileIds: 5,7  (쉼표 구분 또는 여러 파라미터)
- files: (선택한 새 파일들)
```

---

#### 3) **Service 수정**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
@Transactional
public void updateFilesWithKeepOption(Long boardId, List<Long> keepFileIds, List<MultipartFile> newFiles) throws IOException {
    // 1) 기존 파일 전체 조회
    List<BoardFileDto> existingFiles = boardFileMapper.findFilesByBoardId(boardId);

    // 2) 삭제할 파일 식별
    for (BoardFileDto file : existingFiles) {
        if (keepFileIds == null || !keepFileIds.contains(file.getId())) {
            // DB에서 삭제
            boardFileMapper.deleteFileById(file.getId());
            // 실제 파일 삭제
            Path path = Paths.get("uploads/" + file.getFilePath());
            Files.deleteIfExists(path);
        }
    }

    // 3) 새 파일 업로드
    if (newFiles != null) {
        for (MultipartFile file : newFiles) {
            if (file.isEmpty()) continue;
            String folder = "uploads/files/";
            String filename = UUID.randomUUID() + "_" + file.getOriginalFilename();
            Path path = Paths.get(folder + filename);
            Files.createDirectories(path.getParent());
            file.transferTo(path.toFile());

            BoardFileDto dto = new BoardFileDto();
            dto.setBoardId(boardId);
            dto.setFileName(file.getOriginalFilename());
            dto.setFilePath("files/" + filename);
            boardFileMapper.insertBoardFile(dto);
        }
    }
}
```

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardController.java`

```java
import java.util.Arrays;

@PutMapping("/{id}/update-with-files")
public ResponseEntity<?> updateBoardWithFileOptions(@PathVariable Long id,
                                                    @RequestParam String title,
                                                    @RequestParam String content,
                                                    @RequestParam(required = false) String keepFileIds,
                                                    @RequestParam(required = false) List<MultipartFile> files) {
    try {
        // 게시글 본문 수정
        BoardDto boardDto = new BoardDto();
        boardDto.setId(id);
        boardDto.setTitle(title);
        boardDto.setContent(content);
        boardService.updateBoard(boardDto);

        // 유지할 파일 목록 처리
        List<Long> keepList = null;
        if (keepFileIds != null && !keepFileIds.isEmpty()) {
            keepList = Arrays.stream(keepFileIds.split(","))
                             .map(String::trim)
                             .map(Long::parseLong)
                             .toList();
        }

        boardFileService.updateFilesWithKeepOption(id, keepList, files);

        return ResponseEntity.ok(Map.of("message", "게시글 수정 및 첨부파일 유지/추가/삭제 처리 성공"));
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}
```

---

#### 5) **테스트**

**PUT 요청**

```
PUT /boards/1/update-with-files
Form-data:
- title: 수정된 게시글 제목
- content: 수정된 게시글 내용
- keepFileIds: 5
- files: (새로운 파일 1~2개)
```

**결과**

* ID=5 첨부파일 유지
* 나머지 기존 첨부파일 삭제
* 새 파일 추가

---

### 결과

* 게시글 수정 시 파일 유지/삭제/추가를 모두 지원
* 사용자 경험 개선 (기존 첨부파일 관리 자유도 ↑)

---

**다음 단계는 `79. 게시글 목록 + 첨부파일 썸네일 표시(이미지형)` 입니다. 진행할까요?**
