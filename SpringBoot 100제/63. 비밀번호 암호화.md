### 63. JWT(Json Web Token) 로그인

---

#### 1) **목표**

* 세션 기반 로그인 대신 **JWT** 토큰 발급
* 클라이언트는 토큰을 `Authorization: Bearer <token>` 헤더로 전달
* 서버는 세션 사용 없이 토큰 검증으로 인증 처리

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
```

---

#### 3) **JWT 유틸리티 작성**

**경로**: `src/main/java/com/example/springbootstart/util/JwtUtil.java`

```java
package com.example.springbootstart.util;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import java.security.Key;
import java.util.Date;

public class JwtUtil {

    private static final Key key = Keys.secretKeyFor(SignatureAlgorithm.HS256);
    private static final long EXPIRATION_TIME = 1000 * 60 * 60; // 1시간

    // 토큰 생성
    public static String generateToken(String email) {
        return Jwts.builder()
                .setSubject(email)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(key)
                .compact();
    }

    // 토큰에서 이메일 추출
    public static String getEmailFromToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
    }
}
```

---

#### 4) **로그인 Service 수정**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
import com.example.springbootstart.util.JwtUtil;

public String loginWithJwt(String email, String password) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("존재하지 않는 이메일입니다.");
    if (!passwordEncoder.matches(password, user.getPassword()))
        throw new RuntimeException("비밀번호가 일치하지 않습니다.");

    // JWT 발급
    return JwtUtil.generateToken(email);
}
```

---

#### 5) **로그인 Controller 추가**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/login-jwt")
public ResponseEntity<?> loginJwt(@RequestParam String email, @RequestParam String password) {
    try {
        String token = userService.loginWithJwt(email, password);
        return ResponseEntity.ok(Map.of("message", "로그인 성공", "token", token));
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(Map.of("message", e.getMessage()));
    }
}
```

---

#### 6) **JWT 인증 필터 작성**

**경로**: `src/main/java/com/example/springbootstart/config/JwtFilter.java`

```java
package com.example.springbootstart.config;

import com.example.springbootstart.util.JwtUtil;
import org.springframework.web.filter.OncePerRequestFilter;
import javax.servlet.FilterChain;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class JwtFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) {
        try {
            String authHeader = request.getHeader("Authorization");
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                String token = authHeader.substring(7);
                String email = JwtUtil.getEmailFromToken(token);
                request.setAttribute("userEmail", email); // Controller에서 활용 가능
            }
            filterChain.doFilter(request, response);
        } catch (Exception e) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        }
    }
}
```

---

#### 7) **Filter 등록**

**경로**: `src/main/java/com/example/springbootstart/config/WebConfig.java`

```java
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;

@Bean
public FilterRegistrationBean<JwtFilter> jwtFilter() {
    FilterRegistrationBean<JwtFilter> registrationBean = new FilterRegistrationBean<>();
    registrationBean.setFilter(new JwtFilter());
    registrationBean.addUrlPatterns("/boards/*"); // 게시글 관련 요청 JWT 인증 필요
    return registrationBean;
}
```

---

#### 8) **테스트**

1. **로그인 요청**

   ```
   POST http://localhost:8080/users/login-jwt
   Body(x-www-form-urlencoded)
   email=hong@test.com&password=1234
   ```

   **응답**

   ```json
   {
     "message": "로그인 성공",
     "token": "eyJhbGciOiJIUzI1NiJ9..."
   }
   ```

2. **게시글 작성 (JWT 인증)**

   ```
   POST http://localhost:8080/boards
   Header:
   Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
   Body(JSON):
   {
     "title": "JWT 인증 글",
     "content": "JWT 인증 성공"
   }
   ```

   **응답**

   ```json
   {
     "message": "게시글 등록 성공"
   }
   ```

---

#### 9) **결과**

* 세션 없이 토큰 기반 인증 처리 가능
* 확장성(모바일, 외부 API) 높음

---

**다음 단계는 `64. JWT + 사용자 권한(Role) 적용` 입니다. 진행할까요?**
