### 94. 파일 접근 로그 엑셀 다운로드

---

#### 1) **목표**

* 파일 접근 로그를 **Excel(xlsx)** 형식으로 다운로드
* 조건 필터링 지원 (파일 ID, 사용자 ID, 액션타입, 날짜 범위)

---

#### 2) **의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.5</version>
</dependency>
```

> **Apache POI**: Excel 파일 생성 라이브러리

---

#### 3) **Service (엑셀 생성)**

**경로**: `src/main/java/com/example/springbootstart/service/FileAccessLogService.java`

```java
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.http.*;

public ResponseEntity<ByteArrayResource> exportLogsToExcel(Long fileId, Long userId, String actionType,
                                                           String startDate, String endDate) throws IOException {
    // 로그 조회
    List<FileAccessLogDto> logs = logMapper.findAccessLogs(Map.of(
            "fileId", fileId,
            "userId", userId,
            "actionType", actionType,
            "startDate", startDate,
            "endDate", endDate
    ));

    // Workbook 생성
    Workbook workbook = new XSSFWorkbook();
    Sheet sheet = workbook.createSheet("Access Logs");

    // Header
    Row header = sheet.createRow(0);
    header.createCell(0).setCellValue("File ID");
    header.createCell(1).setCellValue("User ID");
    header.createCell(2).setCellValue("Action");
    header.createCell(3).setCellValue("Access Time");

    // Data
    int rowIdx = 1;
    for (FileAccessLogDto log : logs) {
        Row row = sheet.createRow(rowIdx++);
        row.createCell(0).setCellValue(log.getFileId());
        row.createCell(1).setCellValue(log.getUserId() != null ? log.getUserId() : 0);
        row.createCell(2).setCellValue(log.getActionType());
        row.createCell(3).setCellValue(log.getAccessTime());
    }

    // Auto-size columns
    for (int i = 0; i < 4; i++) sheet.autoSizeColumn(i);

    // Output
    ByteArrayOutputStream out = new ByteArrayOutputStream();
    workbook.write(out);
    workbook.close();

    ByteArrayResource resource = new ByteArrayResource(out.toByteArray());

    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"file_access_logs.xlsx\"")
            .contentType(MediaType.parseMediaType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"))
            .contentLength(resource.contentLength())
            .body(resource);
}
```

---

#### 4) **Controller**

**경로**: `src/main/java/com/example/springbootstart/controller/FileAccessLogController.java`

```java
@GetMapping("/excel")
public ResponseEntity<ByteArrayResource> downloadExcel(
        @RequestParam(required = false) Long fileId,
        @RequestParam(required = false) Long userId,
        @RequestParam(required = false) String actionType,
        @RequestParam(required = false) String startDate,
        @RequestParam(required = false) String endDate) throws IOException {
    return logService.exportLogsToExcel(fileId, userId, actionType, startDate, endDate);
}
```

---

#### 5) **테스트**

**GET 요청**

```
GET /file-access-logs/excel?actionType=DOWNLOAD
```

**결과**

* 파일 다운로드: `file_access_logs.xlsx`
* 엑셀 내용:

  * **Header**: File ID | User ID | Action | Access Time
  * **Data**: 조회된 로그 데이터

---

### 결과

* 파일 접근 로그를 Excel로 다운로드 가능
* 필터링 지원 → 특정 조건 로그만 추출 가능

---

**다음 단계는 `95. 파일 접근 로그 CSV 다운로드` 입니다. 진행할까요?**
