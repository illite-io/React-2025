### 51. MyBatis resultMap 고급 매핑 (중첩 매핑)

---

#### 1) **목표**

* MyBatis `resultMap` 기능을 활용하여 \*\*게시글 + 작성자 + 댓글(작성자 포함)\*\*을 **하나의 쿼리 실행**으로 매핑
* 기존 `JOIN + 두 번 쿼리` → **하나의 Mapper 호출**로 처리

---

#### 2) **중첩 매핑 구조**

* **BoardDto** 내부에 `UserDto`(작성자), `List<CommentDto>`(댓글 리스트)를 포함
* 댓글(`CommentDto`) 내부에도 `UserDto`(작성자) 포함

---

#### 3) **DTO 수정**

**경로**: `src/main/java/com/example/springbootstart/dto/BoardWithNestedDto.java`

```java
package com.example.springbootstart.dto;

import lombok.Getter;
import lombok.Setter;
import java.util.List;

@Getter
@Setter
public class BoardWithNestedDto {
    private Long id;
    private String title;
    private String content;
    private String createdAt;
    private String updatedAt;

    private UserDto writer;                // 작성자
    private List<CommentWithWriterDto> comments;  // 댓글 리스트
}
```

**경로**: `src/main/java/com/example/springbootstart/dto/CommentWithWriterDto.java`

```java
package com.example.springbootstart.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class CommentWithWriterDto {
    private Long id;
    private String content;
    private String createdAt;
    private UserDto writer; // 댓글 작성자
}
```

---

#### 4) **Mapper 인터페이스**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardMapper.java`

```java
package com.example.springbootstart.mapper;

import com.example.springbootstart.dto.BoardWithNestedDto;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface BoardMapper {
    BoardWithNestedDto findBoardWithNested(Long id);
}
```

---

#### 5) **Mapper XML (중첩 매핑)**

**경로**: `src/main/resources/mapper/BoardMapper.xml`

```xml
<resultMap id="UserMap" type="com.example.springbootstart.dto.UserDto">
    <id property="id" column="user_id"/>
    <result property="name" column="user_name"/>
    <result property="email" column="user_email"/>
</resultMap>

<resultMap id="CommentWithWriterMap" type="com.example.springbootstart.dto.CommentWithWriterDto">
    <id property="id" column="comment_id"/>
    <result property="content" column="comment_content"/>
    <result property="createdAt" column="comment_created_at"/>
    <association property="writer" javaType="com.example.springbootstart.dto.UserDto">
        <id property="id" column="comment_user_id"/>
        <result property="name" column="comment_user_name"/>
        <result property="email" column="comment_user_email"/>
    </association>
</resultMap>

<resultMap id="BoardWithNestedMap" type="com.example.springbootstart.dto.BoardWithNestedDto">
    <id property="id" column="board_id"/>
    <result property="title" column="board_title"/>
    <result property="content" column="board_content"/>
    <result property="createdAt" column="board_created_at"/>
    <result property="updatedAt" column="board_updated_at"/>
    <association property="writer" resultMap="UserMap"/>
    <collection property="comments" ofType="com.example.springbootstart.dto.CommentWithWriterDto" resultMap="CommentWithWriterMap"/>
</resultMap>

<select id="findBoardWithNested" parameterType="long" resultMap="BoardWithNestedMap">
    SELECT 
        b.id AS board_id, b.title AS board_title, b.content AS board_content,
        b.created_at AS board_created_at, b.updated_at AS board_updated_at,
        u.id AS user_id, u.name AS user_name, u.email AS user_email,
        c.id AS comment_id, c.content AS comment_content, c.created_at AS comment_created_at,
        cu.id AS comment_user_id, cu.name AS comment_user_name, cu.email AS comment_user_email
    FROM board b
    JOIN user u ON b.user_id = u.id
    LEFT JOIN comment c ON c.board_id = b.id
    LEFT JOIN user cu ON c.user_id = cu.id
    WHERE b.id = #{id}
</select>
```

---

#### 6) **Service**

```java
public BoardWithNestedDto getBoardWithNested(Long id) {
    return boardMapper.findBoardWithNested(id);
}
```

---

#### 7) **Controller**

```java
@GetMapping("/nested/{id}")
public ResponseEntity<?> getBoardWithNested(@PathVariable Long id) {
    var board = boardService.getBoardWithNested(id);
    return board != null ? ResponseEntity.ok(board) : ResponseEntity.notFound().build();
}
```

---

#### 8) **테스트 요청**

```
GET http://localhost:8080/boards/nested/1
```

**응답(JSON)**

```json
{
  "id": 1,
  "title": "첫 번째 게시글",
  "content": "안녕하세요, 첫 번째 게시글입니다.",
  "writer": {
    "id": 1,
    "name": "홍길동",
    "email": "hong@test.com"
  },
  "comments": [
    {
      "id": 1,
      "content": "첫 댓글입니다. 반갑습니다.",
      "writer": {
        "id": 2,
        "name": "이순신",
        "email": "lee@test.com"
      }
    }
  ]
}
```

---

**다음 단계는 `52. 페이징 처리 (게시글 목록)` 입니다. 진행할까요?**
