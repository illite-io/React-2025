### 65. 회원가입 이메일 인증 (토큰 발송)

---

#### 1) **목표**

* 회원가입 시 이메일 인증 토큰 발송
* 사용자가 이메일 인증 완료해야 활성 계정으로 전환

---

#### 2) **테이블 변경**

**SQL**

```sql
ALTER TABLE user ADD COLUMN is_verified BOOLEAN DEFAULT FALSE AFTER role;
ALTER TABLE user ADD COLUMN verify_token VARCHAR(100) AFTER is_verified;
```

---

#### 3) **메일 발송 의존성 추가**

**pom.xml**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

---

#### 4) **메일 설정 (application.yml)**

```yaml
spring:
  mail:
    host: smtp.gmail.com
    port: 587
    username: your_email@gmail.com
    password: your_password
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
```

> Gmail 계정 사용 시 **앱 비밀번호** 발급 필요

---

#### 5) **메일 서비스 작성**

**경로**: `src/main/java/com/example/springbootstart/service/MailService.java`

```java
package com.example.springbootstart.service;

import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Service
public class MailService {

    private final JavaMailSender mailSender;
    public MailService(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void sendVerificationEmail(String email, String token) {
        String link = "http://localhost:8080/users/verify?token=" + token;
        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(email);
        message.setSubject("회원가입 이메일 인증");
        message.setText("다음 링크를 클릭하여 이메일을 인증하세요: " + link);
        mailSender.send(message);
    }
}
```

---

#### 6) **회원가입 시 토큰 발급**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
import java.util.UUID;

@Transactional
public int registerUser(UserDto userDto) {
    if (isEmailDuplicated(userDto.getEmail())) {
        throw new RuntimeException("이미 사용 중인 이메일입니다.");
    }
    userDto.setPassword(passwordEncoder.encode(userDto.getPassword()));

    // 인증 토큰 생성
    String token = UUID.randomUUID().toString();
    userDto.setVerifyToken(token);
    userDto.setIsVerified(false);

    int result = userMapper.insertUser(userDto);
    if (result == 1) {
        mailService.sendVerificationEmail(userDto.getEmail(), token);
    }
    return result;
}
```

---

#### 7) **이메일 인증 처리**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@GetMapping("/verify")
public ResponseEntity<?> verifyEmail(@RequestParam String token) {
    int result = userService.verifyUser(token);
    return result == 1 ? ResponseEntity.ok("이메일 인증 완료")
                       : ResponseEntity.badRequest().body("유효하지 않은 토큰");
}
```

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
public int verifyUser(String token) {
    UserDto user = userMapper.findByVerifyToken(token);
    if (user == null) return 0;
    userMapper.updateVerified(user.getId());
    return 1;
}
```

---

#### 8) **Mapper 수정**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
UserDto findByVerifyToken(@Param("token") String token);
int updateVerified(@Param("id") Long id);
```

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<select id="findByVerifyToken" parameterType="string" resultType="com.example.springbootstart.dto.UserDto">
    SELECT * FROM user WHERE verify_token = #{token}
</select>

<update id="updateVerified" parameterType="long">
    UPDATE user
    SET is_verified = TRUE, verify_token = NULL
    WHERE id = #{id}
</update>
```

---

#### 9) **테스트**

1. 회원가입 → 이메일 인증 메일 발송
2. 메일에 포함된 링크 클릭

   ```
   GET http://localhost:8080/users/verify?token=abcd-efgh-1234
   ```
3. 응답

   ```
   이메일 인증 완료
   ```

---

### 결과

* 회원가입 시 메일 인증 프로세스 추가
* 인증 완료 전에는 `is_verified=false` 상태 → 로그인 차단 가능

---

**다음 단계는 `66. 이메일 인증 안 된 계정 로그인 차단` 입니다. 진행할까요?**
