### 67. 비밀번호 재설정 (이메일 링크)

---

#### 1) **목표**

* 사용자가 비밀번호를 잊었을 때 이메일로 재설정 링크 전송
* 링크 클릭 → 새 비밀번호 입력 → 비밀번호 변경 처리

---

#### 2) **DB 컬럼 추가 (토큰)**

**SQL**

```sql
ALTER TABLE user ADD COLUMN reset_token VARCHAR(100) AFTER verify_token;
```

---

#### 3) **MailService 재사용**

기존 `MailService` 활용 (65단계에서 작성됨)

---

#### 4) **비밀번호 재설정 요청 API**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/password-reset-request")
public ResponseEntity<?> requestPasswordReset(@RequestParam String email) {
    try {
        userService.sendPasswordResetLink(email);
        return ResponseEntity.ok("비밀번호 재설정 메일이 발송되었습니다.");
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    }
}
```

---

#### 5) **UserService (재설정 링크 발송)**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
import java.util.UUID;

@Transactional
public void sendPasswordResetLink(String email) {
    UserDto user = userMapper.findByEmail(email);
    if (user == null) throw new RuntimeException("등록된 이메일이 없습니다.");

    String token = UUID.randomUUID().toString();
    userMapper.updateResetToken(user.getId(), token);

    String link = "http://localhost:8080/users/password-reset?token=" + token;
    mailService.sendVerificationEmail(email, token); // 기존 메일 함수 재사용 가능 (텍스트 수정 필요)
}
```

---

#### 6) **Mapper 추가**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
int updateResetToken(@Param("id") Long id, @Param("token") String token);
UserDto findByResetToken(@Param("token") String token);
int updatePassword(@Param("id") Long id, @Param("password") String password);
```

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<update id="updateResetToken">
    UPDATE user SET reset_token = #{token} WHERE id = #{id}
</update>

<select id="findByResetToken" parameterType="string" resultType="com.example.springbootstart.dto.UserDto">
    SELECT * FROM user WHERE reset_token = #{token}
</select>

<update id="updatePassword">
    UPDATE user SET password = #{password}, reset_token = NULL WHERE id = #{id}
</update>
```

---

#### 7) **비밀번호 재설정 API**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/password-reset")
public ResponseEntity<?> resetPassword(@RequestParam String token,
                                       @RequestParam String newPassword) {
    try {
        userService.resetPassword(token, newPassword);
        return ResponseEntity.ok("비밀번호가 성공적으로 변경되었습니다.");
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    }
}
```

---

#### 8) **UserService (비밀번호 변경)**

```java
@Transactional
public void resetPassword(String token, String newPassword) {
    UserDto user = userMapper.findByResetToken(token);
    if (user == null) throw new RuntimeException("유효하지 않은 토큰입니다.");

    String encodedPassword = passwordEncoder.encode(newPassword);
    userMapper.updatePassword(user.getId(), encodedPassword);
}
```

---

#### 9) **테스트**

1. **비밀번호 재설정 요청**

   ```
   POST /users/password-reset-request
   Body: email=test@test.com
   ```

   **응답**

   ```
   비밀번호 재설정 메일이 발송되었습니다.
   ```

   → 이메일에 링크 포함: `http://localhost:8080/users/password-reset?token=abcd-1234`

2. **비밀번호 변경**

   ```
   POST /users/password-reset?token=abcd-1234
   Body: newPassword=5678
   ```

   **응답**

   ```
   비밀번호가 성공적으로 변경되었습니다.
   ```

---

### 결과

* 이메일 기반 비밀번호 재설정 프로세스 완성
* 토큰 사용 후 자동 초기화 → 보안 강화

---

**다음 단계는 `68. 프로필 이미지 업로드 (Multipart)` 입니다. 진행할까요?**
