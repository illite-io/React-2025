### 70. 게시글 첨부파일 업로드

---

#### 1) **목표**

* 게시글 작성/수정 시 **첨부파일 업로드** 기능 제공
* 파일은 `uploads/board` 폴더에 저장
* DB에 파일 경로와 원본 파일명 저장

---

#### 2) **DB 테이블 생성**

**SQL**

```sql
CREATE TABLE board_file (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    board_id BIGINT NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    stored_path VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_board_file_board FOREIGN KEY (board_id) REFERENCES board (id)
);
```

---

#### 3) **DTO 작성**

**경로**: `src/main/java/com/example/springbootstart/dto/BoardFileDto.java`

```java
package com.example.springbootstart.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class BoardFileDto {
    private Long id;
    private Long boardId;
    private String originalName;
    private String storedPath;
    private String createdAt;
}
```

---

#### 4) **Mapper 작성**

**경로**: `src/main/java/com/example/springbootstart/mapper/BoardFileMapper.java`

```java
package com.example.springbootstart.mapper;

import com.example.springbootstart.dto.BoardFileDto;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface BoardFileMapper {
    int insertFile(BoardFileDto fileDto);
    List<BoardFileDto> findFilesByBoardId(@Param("boardId") Long boardId);
}
```

**경로**: `src/main/resources/mapper/BoardFileMapper.xml`

```xml
<mapper namespace="com.example.springbootstart.mapper.BoardFileMapper">
    <insert id="insertFile" parameterType="com.example.springbootstart.dto.BoardFileDto">
        INSERT INTO board_file (board_id, original_name, stored_path)
        VALUES (#{boardId}, #{originalName}, #{storedPath})
    </insert>

    <select id="findFilesByBoardId" parameterType="long" resultType="com.example.springbootstart.dto.BoardFileDto">
        SELECT id, board_id AS boardId, original_name AS originalName,
               stored_path AS storedPath, created_at AS createdAt
        FROM board_file
        WHERE board_id = #{boardId}
    </select>
</mapper>
```

---

#### 5) **Service 작성**

**경로**: `src/main/java/com/example/springbootstart/service/BoardFileService.java`

```java
package com.example.springbootstart.service;

import com.example.springbootstart.dto.BoardFileDto;
import com.example.springbootstart.mapper.BoardFileMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class BoardFileService {

    private final BoardFileMapper boardFileMapper;

    public BoardFileService(BoardFileMapper boardFileMapper) {
        this.boardFileMapper = boardFileMapper;
    }

    @Transactional
    public void saveFile(Long boardId, String originalName, String storedPath) {
        BoardFileDto fileDto = new BoardFileDto();
        fileDto.setBoardId(boardId);
        fileDto.setOriginalName(originalName);
        fileDto.setStoredPath(storedPath);
        boardFileMapper.insertFile(fileDto);
    }

    public List<BoardFileDto> getFiles(Long boardId) {
        return boardFileMapper.findFilesByBoardId(boardId);
    }
}
```

---

#### 6) **Controller 작성 (파일 업로드)**

**경로**: `src/main/java/com/example/springbootstart/controller/BoardFileController.java`

```java
package com.example.springbootstart.controller;

import com.example.springbootstart.service.BoardFileService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

@RestController
@RequestMapping("/boards/files")
public class BoardFileController {

    private final BoardFileService boardFileService;

    public BoardFileController(BoardFileService boardFileService) {
        this.boardFileService = boardFileService;
    }

    @PostMapping("/{boardId}")
    public ResponseEntity<?> uploadFile(@PathVariable Long boardId, @RequestParam("file") MultipartFile file) {
        try {
            if (file.isEmpty()) return ResponseEntity.badRequest().body("파일이 없습니다.");

            // 저장 경로
            String folder = "uploads/board/";
            Files.createDirectories(Paths.get(folder));
            String filename = boardId + "_" + file.getOriginalFilename();
            Path path = Paths.get(folder + filename);
            file.transferTo(path.toFile());

            // DB에 저장
            boardFileService.saveFile(boardId, file.getOriginalFilename(), "board/" + filename);

            return ResponseEntity.ok("첨부파일 업로드 성공");
        } catch (Exception e) {
            return ResponseEntity.status(500).body(e.getMessage());
        }
    }

    @GetMapping("/{boardId}")
    public ResponseEntity<?> getFiles(@PathVariable Long boardId) {
        return ResponseEntity.ok(boardFileService.getFiles(boardId));
    }
}
```

---

#### 7) **파일 접근 URL 설정**

기존(69단계) `WebConfig`에 추가:

```java
registry.addResourceHandler("/images/board/**")
        .addResourceLocations("file:uploads/board/");
```

---

#### 8) **테스트**

1. **파일 업로드**

   ```
   POST http://localhost:8080/boards/files/1
   Form-Data:
   file: (선택)
   ```

   **응답**

   ```
   첨부파일 업로드 성공
   ```

2. **파일 조회**

   ```
   GET http://localhost:8080/boards/files/1
   ```

   **응답(JSON)**

   ```json
   [
     {
       "id": 1,
       "boardId": 1,
       "originalName": "test.png",
       "storedPath": "board/1_test.png",
       "createdAt": "2025-08-03T12:30:00"
     }
   ]
   ```

3. **브라우저 접근**

   ```
   http://localhost:8080/images/board/1_test.png
   ```

   → 이미지 표시

---

### 결과

* 게시글 첨부파일 업로드 및 조회 기능 완성
* 정적 URL 제공으로 프론트엔드 쉽게 접근 가능

---

**다음 단계는 `71. 첨부파일 삭제` 입니다. 진행할까요?**
