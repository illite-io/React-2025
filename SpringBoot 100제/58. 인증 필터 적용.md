### 58. 회원 가입 시 중복 이메일 체크

---

#### 1) **목표**

* 회원 가입 시 **이미 사용 중인 이메일**인지 검사
* 중복 이메일이면 가입 불가 처리

---

#### 2) **Mapper 인터페이스**

**경로**: `src/main/java/com/example/springbootstart/mapper/UserMapper.java`

```java
package com.example.springbootstart.mapper;

import com.example.springbootstart.dto.UserDto;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper {
    UserDto findUserById(@Param("id") Long id);
    int countByEmail(@Param("email") String email);  // 이메일 중복 체크
}
```

---

#### 3) **Mapper XML**

**경로**: `src/main/resources/mapper/UserMapper.xml`

```xml
<select id="countByEmail" parameterType="string" resultType="int">
    SELECT COUNT(*) FROM user WHERE email = #{email}
</select>
```

---

#### 4) **Service 수정**

**경로**: `src/main/java/com/example/springbootstart/service/UserService.java`

```java
public boolean isEmailDuplicated(String email) {
    return userMapper.countByEmail(email) > 0;
}

@Transactional
public int registerUser(UserDto userDto) {
    if (isEmailDuplicated(userDto.getEmail())) {
        throw new RuntimeException("이미 사용 중인 이메일입니다.");
    }
    return userMapper.insertUser(userDto);
}
```

> **주의:** `insertUser()` 메서드는 기존 단계(31)에서 작성되어 있어야 함

---

#### 5) **Controller 수정**

**경로**: `src/main/java/com/example/springbootstart/controller/UserController.java`

```java
@PostMapping("/register")
public ResponseEntity<?> registerUser(@Valid @RequestBody UserDto userDto) {
    try {
        int result = userService.registerUser(userDto);
        return result == 1 ? ResponseEntity.ok("회원 가입 성공")
                           : ResponseEntity.badRequest().body("회원 가입 실패");
    } catch (RuntimeException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    }
}
```

---

#### 6) **테스트 요청**

**POST 요청**

```
http://localhost:8080/users/register
```

**Body(JSON)**

```json
{
  "name": "홍길동",
  "age": 30,
  "email": "hong@test.com"
}
```

**응답**

```
이미 사용 중인 이메일입니다.
```

---

#### 7) **결과**

* 중복 이메일인 경우 예외 처리되어 가입 거부
* 중복이 아닐 경우 정상적으로 가입 처리됨

---

**다음 단계는 `59. 회원 로그인 (세션 기반)` 입니다. 진행할까요?**
